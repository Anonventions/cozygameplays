<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CozyBeds üíï - Romance RPG</title>
    <style>
        @font-face {
            font-family: 'Quaver';
            src: url('https://raw.githubusercontent.com/Anonventions/cozygameplays/main/font/quaver.ttf') format('truetype');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        body {
            font-family: 'Quaver', Arial, sans-serif;
            overflow: hidden;
            background: #1a1a2e;
        }

        /* Cinematic Fade Effects */
        #cinematicFade {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 20000;
            pointer-events: none;
            opacity: 1;
            transition: opacity 2s ease;
        }

        #cinematicFade.fade-out {
            opacity: 0;
        }

        #cinematicFade.fade-in {
            opacity: 1;
            pointer-events: all;
        }

        /* End Game Screen */
        #endGameScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 19000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 40px;
        }

        #endGameScreen.show {
            display: flex;
        }

        #endGameScreen h2 {
            font-size: 48px;
            color: white;
            text-shadow: 0 0 30px rgba(248,187,208,1);
            animation: gentlePulse 3s ease-in-out infinite;
        }

        @keyframes gentlePulse {
            0%, 100% { 
                opacity: 0.8; 
                transform: scale(1);
                text-shadow: 0 0 30px rgba(248,187,208,1);
            }
            50% { 
                opacity: 1; 
                transform: scale(1.05);
                text-shadow: 0 0 40px rgba(248,187,208,1), 0 0 60px rgba(244,143,177,0.8);
            }
        }

        .end-game-buttons {
            display: flex;
            gap: 30px;
        }

        .end-game-btn {
            padding: 20px 40px;
            font-family: 'Quaver', Arial;
            font-size: 24px;
            border: 3px solid rgba(255,182,193,0.8);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .end-game-btn.play-again {
            background: linear-gradient(135deg, rgba(248,187,208,0.95), rgba(244,143,177,0.95));
        }

        .end-game-btn.stay {
            background: linear-gradient(135deg, rgba(198,160,246,0.95), rgba(157,129,204,0.95));
        }

        .end-game-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 40px rgba(248,187,208,0.5);
        }

        /* Settings Button */
        #settingsBtn {
            position: fixed;
            top: 25px;
            left: 25px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, rgba(198,160,246,0.95), rgba(157,129,204,0.95));
            border: 3px solid rgba(210,180,230,0.6);
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(198,160,246,0.4);
        }

        #settingsBtn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 30px rgba(198,160,246,0.6);
        }

        /* Settings Panel */
        #settingsPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 500px;
            background: linear-gradient(135deg, rgba(198,160,246,0.98), rgba(157,129,204,0.98));
            padding: 30px;
            border-radius: 20px;
            z-index: 2000;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 3px solid rgba(210,180,230,0.8);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        #settingsPanel.show {
            transform: translate(-50%, -50%) scale(1);
        }

        #settingsPanel h2 {
            color: white;
            font-size: 28px;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .setting-group {
            margin: 20px 0;
        }

        .setting-group label {
            display: block;
            color: white;
            font-size: 18px;
            margin-bottom: 10px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* Mute Toggle Switch */
        .mute-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0,0,0,0.3);
            padding: 12px 20px;
            border-radius: 15px;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: rgba(255,255,255,0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #F8BBD0, #F48FB1);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }

        .theme-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .theme-btn {
            padding: 12px 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-family: 'Quaver', Arial;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .theme-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
            border-color: rgba(255,255,255,0.6);
        }

        .theme-btn.active {
            background: linear-gradient(135deg, #F8BBD0, #F48FB1);
            border-color: #FFE082;
            box-shadow: 0 0 20px rgba(248,187,208,0.6);
        }

        #closeSettings {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: linear-gradient(135deg, #F8BBD0, #F48FB1);
            border: none;
            border-radius: 15px;
            color: white;
            font-family: 'Quaver', Arial;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        #closeSettings:hover {
            background: linear-gradient(135deg, #F48FB1, #EC407A);
            transform: scale(1.05);
        }

        /* Dialogue Choices Container */
        #dialogueChoices {
            position: fixed;
            bottom: -300px;
            left: 50%;
            transform: translateX(-50%);
            width: 770px;
            z-index: 1001;
            transition: bottom 0.45s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0 60px;
        }

        #dialogueChoices.show {
            bottom: 310px;
        }

        .choice-btn {
            padding: 15px 25px 15px 70px;
            background: linear-gradient(135deg, rgba(248,187,208,0.95), rgba(244,143,177,0.95));
            border: 3px solid rgba(255,224,230,0.8);
            border-radius: 20px;
            color: white;
            font-family: 'Quaver', Arial;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            position: relative;
            box-shadow: 0 5px 15px rgba(248,187,208,0.4);
        }

        .choice-btn::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background-image: url('https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/talk_popup/her.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .choice-btn:hover {
            background: linear-gradient(135deg, #F48FB1, #EC407A);
            transform: translateX(10px) scale(1.02);
            box-shadow: 0 8px 25px rgba(248,187,208,0.6);
        }

        .choice-btn.playful {
            border-color: #FFE082;
        }

        .choice-btn.sarcastic {
            border-color: #CE93D8;
        }

        .choice-btn.flirty {
            border-color: #F8BBD0;
        }

        /* Weather Effects */
        .weather-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            overflow: hidden;
        }

        .snowflake, .raindrop, .petal {
            position: absolute;
            pointer-events: none;
        }

        .snowflake {
            color: white;
            font-size: 20px;
            opacity: 0.8;
            animation: fall 10s linear infinite;
        }

        .raindrop {
            width: 2px;
            height: 20px;
            background: linear-gradient(180deg, transparent, rgba(174,194,224,0.8));
            animation: rain 1s linear infinite;
        }

        .petal {
            width: 10px;
            height: 10px;
            background: #FFB7C5;
            border-radius: 50% 0;
            opacity: 0.8;
            animation: fallPetal 12s ease-in infinite;
        }

        @keyframes fall {
            0% {
                transform: translateY(-10vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(110vh) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes rain {
            0% {
                transform: translateY(-20px);
                opacity: 0.8;
            }
            100% {
                transform: translateY(620px);
                opacity: 0;
            }
        }

        @keyframes fallPetal {
            0% {
                transform: translateY(-10vh) rotate(0deg) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(110vh) rotate(720deg) translateX(100px);
                opacity: 0;
            }
        }

        /* Enhanced Loading Screen */
        #loadScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #B39DDB 0%, #9FA8DA 25%, #F8BBD0 50%, #B2DFDB 75%, #C5E1A5 100%);
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 1s, transform 1s;
        }

        #loadScreen.hidden {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .loading-heart {
            position: absolute;
            font-size: 30px;
            animation: floatHeart 6s infinite ease-in-out;
            opacity: 0;
        }

        @keyframes floatHeart {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }

        #loadScreen h1 {
            font-size: 72px;
            color: white;
            text-shadow: 0 0 20px rgba(255,255,255,0.8),
                         0 0 40px rgba(248,187,208,0.6),
                         0 0 60px rgba(244,143,177,0.4);
            margin-bottom: 40px;
            animation: titlePulse 2s ease-in-out infinite;
            z-index: 10;
        }

        @keyframes titlePulse {
            0%, 100% {
                transform: scale(1);
                text-shadow: 0 0 20px rgba(255,255,255,0.8),
                             0 0 40px rgba(248,187,208,0.6),
                             0 0 60px rgba(244,143,177,0.4);
            }
            50% {
                transform: scale(1.05);
                text-shadow: 0 0 30px rgba(255,255,255,1),
                             0 0 60px rgba(248,187,208,0.8),
                             0 0 90px rgba(244,143,177,0.6);
            }
        }

        .instruction {
            font-size: 24px;
            color: white;
            background: rgba(255,255,255,0.2);
            padding: 20px 40px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            animation: instructionFloat 3s ease-in-out infinite;
            z-index: 10;
            margin-bottom: 50px;
        }

        @keyframes instructionFloat {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-15px);
            }
        }

        .loading-bar-container {
            width: 400px;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            z-index: 10;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b9d, #c06c84, #f67280, #355c7d);
            background-size: 200% 100%;
            animation: loadingProgress 2.5s ease-in-out forwards, shimmer 1.5s infinite;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255,107,157,0.6);
        }

        @keyframes loadingProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        @keyframes shimmer {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }

        /* RPG Stats Panel */
        #statsPanel {
            position: fixed;
            top: 25px;
            right: 25px;
            width: 320px;
            height: 280px;
            background-image: url('https://raw.githubusercontent.com/Anonventions/cozygameplays/main/buttons/stats.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            padding: 20px;
            z-index: 500;
            display: flex;
            flex-direction: column;
            animation: fadeInSlide 0.8s ease-out;
        }

        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #statsPanel h3 {
            color: #fff;
            font-size: 22px;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .stat-row {
            margin: 10px 0;
            color: white;
            font-size: 14px;
        }

        .stat-label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
        }

        .stat-value {
            color: #FFE082;
            text-shadow: 0 0 10px rgba(255,224,130,0.5);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #F8BBD0, #F48FB1);
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(248,187,208,0.6);
        }

        /* Inventory System */
        #inventory {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 280px;
            height: 160px;
            background-image: url('https://raw.githubusercontent.com/Anonventions/cozygameplays/main/buttons/inventory.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            padding: 15px;
            z-index: 500;
            display: flex;
            flex-direction: column;
            animation: fadeInSlide 0.8s ease-out 0.2s backwards;
        }

        #inventory h4 {
            color: white;
            font-size: 18px;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .inventory-slot {
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .inventory-slot:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
            border-color: #FFE082;
        }

        .inventory-slot.filled {
            background: rgba(255,224,130,0.2);
            border-color: #FFE082;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Achievement System */
        #achievementNotif {
            position: fixed;
            top: -200px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255,224,130,0.95), rgba(255,213,79,0.95));
            padding: 20px 30px;
            border-radius: 15px;
            z-index: 1500;
            box-shadow: 0 10px 40px rgba(255,224,130,0.5);
            border: 3px solid #FFE082;
            transition: top 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-width: 350px;
            text-align: center;
        }

        #achievementNotif.show {
            top: 100px;
        }

        #achievementNotif h4 {
            color: #fff;
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        #achievementNotif p {
            color: #fff;
            font-size: 16px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        #sleepOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 30, 0);
            pointer-events: none;
            z-index: 998;
            transition: background 3s ease;
        }

        #sleepOverlay.active {
            background: rgba(0, 0, 30, 0.7);
        }

        #sleepMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: white;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            z-index: 999;
            text-shadow: 0 0 30px rgba(255,182,193,1),
                         0 0 60px rgba(255,105,180,0.8);
            transition: opacity 2s ease;
        }

        #sleepMessage.show {
            opacity: 1;
        }

        /* Player Name Labels */
        .player-name {
            position: absolute;
            font-family: 'Quaver', Arial, sans-serif;
            font-size: 18px;
            color: #FFB6C1;
            text-shadow: 
                0 0 10px rgba(255,182,193,0.8),
                0 0 20px rgba(255,182,193,0.6),
                2px 2px 4px rgba(0,0,0,0.3);
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
            font-weight: bold;
            animation: nameGlow 2s ease-in-out infinite;
            transition: opacity 0.5s ease;
        }

        @keyframes nameGlow {
            0%, 100% {
                text-shadow: 
                    0 0 10px rgba(255,182,193,0.8),
                    0 0 20px rgba(255,182,193,0.6),
                    2px 2px 4px rgba(0,0,0,0.3);
            }
            50% {
                text-shadow: 
                    0 0 15px rgba(255,182,193,1),
                    0 0 30px rgba(255,182,193,0.8),
                    2px 2px 4px rgba(0,0,0,0.3);
            }
        }

        /* Level Up Effect */
        .levelup-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 72px;
            color: #FFE082;
            text-shadow: 0 0 30px rgba(255,224,130,1);
            z-index: 2000;
            pointer-events: none;
            animation: levelUpAnim 2s ease-out forwards;
        }

        @keyframes levelUpAnim {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1) translateY(-100px);
            }
        }

        /* Game Container */
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: filter 0.5s ease;
        }

        #gameBg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://raw.githubusercontent.com/Anonventions/cozygameplays/main/game_bg.png');
            background-size: cover;
            background-position: center;
            z-index: 1;
            transition: filter 3s ease;
        }

        #gameBg.sleeping {
            filter: brightness(0.4) saturate(0.7);
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, rgba(255,192,203,0.9), rgba(255,182,193,0.4));
            border-radius: 50%;
            pointer-events: none;
            z-index: 3;
            animation: float 10s infinite ease-in-out;
            box-shadow: 0 0 8px rgba(255,182,193,0.6);
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0) scale(1);
                opacity: 0.4;
            }
            50% {
                transform: translateY(-40px) translateX(15px) scale(1.2);
                opacity: 0.9;
            }
        }

        #room {
            position: relative;
            width: 828px;
            height: 618px;
            background-image: url('https://raw.githubusercontent.com/Anonventions/cozygameplays/main/room.png');
            background-size: 828px 618px;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            box-shadow: 0 0 50px rgba(255,182,193,0.4), 0 0 100px rgba(255,105,180,0.2);
            transition: filter 0.5s ease;
        }

        /* Vignette effect */
        #room::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 90;
            border-radius: 15px;
            box-shadow: 
                inset 0 0 120px rgba(0, 0, 0, 0.5),
                inset 0 0 200px rgba(0, 0, 0, 0.3);
            background: radial-gradient(
                ellipse at center,
                transparent 0%,
                transparent 40%,
                rgba(0, 0, 0, 0.25) 70%,
                rgba(0, 0, 0, 0.5) 100%
            );
        }

        .room-item {
            position: absolute;
            pointer-events: none;
        }

        #bed {
            width: 156px;
            height: 372px;
            bottom: 90px;
            left: 23px;
            z-index: 10;
            cursor: pointer;
            transition: filter 0.3s;
        }

        #bed.interactive {
            pointer-events: auto;
        }

        #bed.interactive:hover {
            filter: brightness(1.2) drop-shadow(0 0 15px rgba(248,187,208,0.8));
        }

        #pcTable {
            width: 390px;
            height: 186px;
            top: 100px;
            right: 250px;
            z-index: 10;
            cursor: pointer;
            transition: filter 0.3s;
        }

        #pcTable:hover {
            filter: brightness(1.2) drop-shadow(0 0 15px rgba(198,160,246,0.8));
        }

        #gamingChair {
            width: 96px;
            height: 138px;
            top: 190px;
            right: 385px;
            z-index: 11;
        }

        #rightSideTable {
            width: 165px;
            height: 393px;
            bottom: 100px;
            right: 12px;
            z-index: 11;
        }

        .item {
            position: absolute;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 85;
            width: 48px;
            height: 48px;
            animation: itemGlow 2s ease-in-out infinite;
        }

        @keyframes itemGlow {
            0%, 100% {
                filter: drop-shadow(0 0 5px rgba(255,224,130,0.5));
            }
            50% {
                filter: drop-shadow(0 0 15px rgba(255,224,130,0.9));
            }
        }

        .item:hover {
            transform: translateY(-4px) scale(1.1);
            filter: drop-shadow(0 8px 16px rgba(255,224,130,1)) brightness(1.3);
            animation: none;
        }

        .item.collected {
            opacity: 0;
            pointer-events: none;
            transform: scale(0) rotate(360deg);
            transition: all 0.5s ease;
        }

        #teddybear { top: 290px; left: 120px; }
        #flower { bottom: 220px; left: 120px; }
        #giftbox { top: 160px; right: 110px; }
        #steak { bottom: 270px; right: 20px; }
        #cake { top: 210px; right: 40px; }
        #wine { bottom: 386px; right: 290px; }
        #letter { top: 100px; left: 50%; transform: translateX(-50%); }

        .character {
            position: absolute;
            transition: z-index 0s;
        }

        .character img {
            display: block;
        }

        #her {
            width: 90px;
            height: 210px;
            bottom: 250px;
            left: 350px;
        }

        #herSprite {
            width: 90px;
            height: 210px;
        }

        #him {
            width: 82px;
            height: 233px;
            bottom: 120px;
            right: 250px;
            cursor: pointer;
            transition: filter 0.3s;
            z-index: 11;
        }

        #himSprite {
            width: 85px;
            height: 233px;
        }

        #him:hover {
            filter: brightness(1.25) drop-shadow(0 0 12px rgba(248,187,208,0.9));
        }

        #bedHint {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(198,160,246,0.95), rgba(157,129,204,0.95));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(198,160,246,0.5);
            animation: bounce-hint 1s infinite;
            z-index: 100;
        }

        #bedHint.show {
            opacity: 1;
        }

        #proximityHint {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(248,187,208,0.95), rgba(244,143,177,0.95));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(248,187,208,0.5);
            animation: bounce-hint 1s infinite;
        }

        @keyframes bounce-hint {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }

        #proximityHint.show {
            opacity: 1;
        }

        .effect {
            position: absolute;
            pointer-events: none;
            z-index: 200;
            animation: floatUp 2.5s ease-out forwards;
        }

        .effect.heart-effect {
            width: 48px;
            height: 48px;
        }

        .effect.sparkle-effect {
            width: 96px;
            height: 96px;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(-90px) scale(2) rotate(20deg);
            }
        }

        #textboxContainer {
            position: fixed;
            bottom: -300px;
            left: 50%;
            transform: translateX(-50%);
            width: 770px;
            height: 260px;
            z-index: 1000;
            transition: bottom 0.45s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        #textboxContainer.show {
            bottom: 25px;
        }

        #textboxBg {
            width: 770px;
            height: 260px;
            object-fit: fill;
        }

        #textboxContent {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            padding: 30px 60px 50px 320px;
        }

        #avatarImg {
            position: absolute;
            left: -125px;
            top: 20%;
            transform: translateY(-50%);
            width: 600px;
            height: 300px;
            object-fit: contain;
            transition: transform 0.1s ease-in-out;
        }

        /* Talking animation for avatars */
        #avatarImg.talking {
            animation: avatarTalk 0.5s ease-in-out infinite;
        }

        @keyframes avatarTalk {
            0%, 100% {
                transform: translateY(-50%) translateX(0);
            }
            25% {
                transform: translateY(-50%) translateX(2px) scale(1.01);
            }
            75% {
                transform: translateY(-50%) translateX(-2px) scale(0.99);
            }
        }

        #dialogText {
            font-size: 16px;
            color: #2c2c2c;
            line-height: 1.6;
            flex: 1;
            max-height: 150px;
            overflow-y: auto;
            word-wrap: break-word;
            padding-right: 10px;
        }

        #dialogText::-webkit-scrollbar {
            width: 6px;
        }

        #dialogText::-webkit-scrollbar-thumb {
            background: rgba(255,105,180,0.5);
            border-radius: 3px;
        }

        #continueBtn {
            position: absolute;
            bottom: 30px;
            right: 50px;
            width: 120px;
            height: 50px;
            background-image: url('https://raw.githubusercontent.com/Anonventions/cozygameplays/main/buttons/continue.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            text-indent: -9999px;
            display: none;
        }

        #continueBtn.show {
            display: block;
        }

        #continueBtn:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        #questIndicator {
            position: fixed;
            top: 220px;
            left: 25px;
            width: 360px;
            height: 440px;
            background-image: url('https://raw.githubusercontent.com/Anonventions/cozygameplays/main/buttons/quests.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            padding: 24px;
            z-index: 500;
            max-height: 400px;
            overflow-y: auto;
            animation: fadeInSlide 0.8s ease-out 0.1s backwards;
        }

        #questIndicator h3 {
            margin-bottom: 14px;
            color: #F48FB1;
            font-size: 24px;
            text-shadow: 0 2px 4px rgba(248,187,208,0.3);
        }

        .quest-item {
            padding: 9px 0;
            color: #555;
            font-size: 15px;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .quest-item.completed {
            text-decoration: line-through;
            color: #4caf50;
        }

        .quest-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        .kiss-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,105,180,0.5) 0%, rgba(255,182,193,0.25) 50%, transparent 80%);
            pointer-events: none;
            opacity: 0;
            z-index: 999;
            transition: opacity 0.7s;
        }

        .kiss-overlay.active {
            opacity: 1;
            animation: heartbeat 1.2s infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        .romantic-glow {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 4;
            background: radial-gradient(circle at 50% 50%, 
                rgba(255,182,193,0.2) 0%, 
                rgba(255,105,180,0.12) 30%, 
                transparent 65%);
            animation: glow 5s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.9; }
        }

        .z-particle {
            position: absolute;
            font-size: 36px;
            color: rgba(255, 255, 255, 0.8);
            pointer-events: none;
            animation: floatZ 3s ease-in-out infinite;
            text-shadow: 0 0 10px rgba(255,182,193,0.8);
        }

        @keyframes floatZ {
            0% {
                opacity: 0;
                transform: translateY(0) translateX(0) scale(0.5);
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) translateX(20px) scale(1.2);
            }
        }

        /* Activity Selection UI */
        #activityPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 600px;
            background: linear-gradient(135deg, rgba(248,187,208,0.98), rgba(244,143,177,0.98));
            padding: 30px;
            border-radius: 20px;
            z-index: 2000;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 3px solid rgba(255,224,230,0.8);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        #activityPanel.show {
            transform: translate(-50%, -50%) scale(1);
        }

        #activityPanel h2 {
            color: white;
            font-size: 28px;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .activity-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .activity-btn {
            padding: 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            color: white;
            font-family: 'Quaver', Arial;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .activity-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
            border-color: #FFE082;
        }

        .activity-btn .activity-icon {
            font-size: 36px;
            display: block;
            margin-bottom: 10px;
        }

        /* Item Info Panel */
        #itemInfoPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 500px;
            background: linear-gradient(135deg, rgba(198,160,246,0.98), rgba(157,129,204,0.98));
            padding: 30px;
            border-radius: 20px;
            z-index: 2500;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 3px solid rgba(210,180,230,0.8);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        #itemInfoPanel.show {
            transform: translate(-50%, -50%) scale(1);
        }

        #itemInfoPanel h3 {
            color: white;
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
        }

        #itemInfoIcon {
            font-size: 64px;
            text-align: center;
            margin-bottom: 15px;
        }

        #itemInfoText {
            color: white;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 15px;
            text-align: center;
        }

        #itemInfoGiver {
            color: #FFE082;
            font-size: 14px;
            text-align: center;
            margin-bottom: 20px;
        }

        .close-info-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #F8BBD0, #F48FB1);
            border: none;
            border-radius: 15px;
            color: white;
            font-family: 'Quaver', Arial;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-info-btn:hover {
            background: linear-gradient(135deg, #F48FB1, #EC407A);
            transform: scale(1.05);
        }

        /* New RPG Panel Styles */
        .rpg-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(198,160,246,0.98), rgba(157,129,204,0.98));
            padding: 30px;
            border-radius: 20px;
            z-index: 3000;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 3px solid rgba(210,180,230,0.8);
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            color: white;
        }

        .rpg-panel h2 {
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }

        .rpg-panel button {
            background: linear-gradient(135deg, #F8BBD0, #F48FB1);
            border: 2px solid rgba(255,224,230,0.8);
            border-radius: 10px;
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Quaver', Arial;
        }

        .rpg-panel button:hover {
            background: linear-gradient(135deg, #F48FB1, #EC407A);
            transform: scale(1.05);
        }

        /* Quick Menu */
        #quickMenu {
            position: fixed;
            top: 50%;
            right: 25px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .quick-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, rgba(248,187,208,0.95), rgba(244,143,177,0.95));
            border: 2px solid rgba(255,224,230,0.8);
            border-radius: 10px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(248,187,208,0.6);
        }

        /* Status Effects */
        #statusEffects {
            position: fixed;
            top: 25px;
            left: 400px;
            display: flex;
            gap: 15px;
            z-index: 500;
            font-size: 14px;
        }

        #statusEffects > div {
            background: rgba(198,160,246,0.9);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid rgba(210,180,230,0.6);
            color: white;
        }

        /* Save Slots */
        .save-slots {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .save-slot-btn {
            width: 100%;
            text-align: left;
            padding: 15px !important;
        }

        .save-actions {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .save-actions button {
            flex: 1;
        }

        /* Equipment */
        .equipment-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .eq-tab {
            flex: 1;
            padding: 10px !important;
        }

        .eq-tab.active {
            background: linear-gradient(135deg, #FFE082, #FFD54F) !important;
            color: #333;
        }

        .equipment-grid, .crafting-grid, .cooking-grid, .gift-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .equipment-item, .craft-item, .cook-item, .gift-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .equipment-item:hover, .craft-item:hover, .cook-item:hover, .gift-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .equipment-item.owned {
            border-color: #FFE082;
        }

        .equipment-item.equipped {
            background: linear-gradient(135deg, rgba(255,224,130,0.3), rgba(255,213,79,0.3));
            border-color: #FFE082;
        }

        .currency-display {
            background: rgba(255,224,130,0.2);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            font-size: 18px;
            color: #FFE082;
        }

        /* Skills */
        .skill-points {
            background: rgba(255,224,130,0.2);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            color: #FFE082;
        }

        .skill-trees {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .skill-category h3 {
            font-size: 16px;
            margin-bottom: 10px;
            text-align: center;
        }

        .skill-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .skill-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.2);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .skill-item:hover {
            background: rgba(255,255,255,0.2);
        }

        .skill-item.unlocked {
            background: linear-gradient(135deg, rgba(255,224,130,0.3), rgba(255,213,79,0.3));
            border-color: #FFE082;
        }

        .skill-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Tutorial */
        #tutorialOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tutorial-box {
            background: linear-gradient(135deg, rgba(198,160,246,0.98), rgba(157,129,204,0.98));
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            text-align: center;
            border: 3px solid rgba(210,180,230,0.8);
        }

        .tutorial-box h2 {
            color: white;
            margin-bottom: 20px;
        }

        .tutorial-box #tutorialText {
            color: white;
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .tutorial-box button {
            margin: 0 10px;
        }

        /* Random Event Notification */
        #randomEventNotif {
            position: fixed;
            top: -200px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255,224,130,0.95), rgba(255,213,79,0.95));
            padding: 20px 30px;
            border-radius: 15px;
            z-index: 5000;
            box-shadow: 0 10px 40px rgba(255,224,130,0.5);
            border: 3px solid #FFE082;
            transition: top 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #randomEventNotif.show {
            top: 100px;
        }

        #eventIcon {
            font-size: 32px;
        }

        #eventText {
            color: #333;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- Cinematic Fade Overlay -->
    <div id="cinematicFade"></div>

    <!-- End Game Screen -->
    <div id="endGameScreen">
        <h2>Sweet dreams princess üíïüò¥</h2>
        <div class="end-game-buttons">
            <button class="end-game-btn play-again" id="playAgainBtn">Play Again üîÑ</button>
            <button class="end-game-btn stay" id="stayBtn">Stay Here üíñ</button>
        </div>
    </div>

    <!-- Settings Button -->
    <div id="settingsBtn" onclick="playSound('click')">‚öôÔ∏è</div>

    <!-- Settings Panel -->
    <div id="settingsPanel">
        <h2>‚öôÔ∏è Settings</h2>
        
        <div class="setting-group">
            <label>üîä Sound:</label>
            <div class="mute-toggle">
                <span style="color: white;">Mute Sounds</span>
                <div class="toggle-switch" id="muteToggle">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>

        <div class="setting-group">
            <label>üé® Room Theme:</label>
            <div class="theme-buttons">
                <button class="theme-btn active" data-theme="default" onclick="playSound('click')">
                    <span>üåü</span> Default
                </button>
                <button class="theme-btn" data-theme="snow" onclick="playSound('click')">
                    <span>‚ùÑÔ∏è</span> Snow
                </button>
                <button class="theme-btn" data-theme="rain" onclick="playSound('click')">
                    <span>üåßÔ∏è</span> Rain
                </button>
                <button class="theme-btn" data-theme="sunny" onclick="playSound('click')">
                    <span>‚òÄÔ∏è</span> Sunny
                </button>
                <button class="theme-btn" data-theme="cherry" onclick="playSound('click')">
                    <span>üå∏</span> Cherry Blossom
                </button>
            </div>
        </div>

        <button id="closeSettings" onclick="playSound('click')">Close Settings</button>
    </div>

    <!-- Activity Selection Panel -->
    <div id="activityPanel">
        <h2>üíñ Choose Your Activity</h2>
        <div class="activity-grid">
            <button class="activity-btn" data-activity="drawing">
                <span class="activity-icon">üé®</span>
                Drawing<br><small>+Creativity</small>
            </button>
            <button class="activity-btn" data-activity="watch a documentary">
                <span class="activity-icon">üìö</span>
                watch a documentary<br><small>+Intelligence</small>
            </button>
            <button class="activity-btn" data-activity="workout">
                <span class="activity-icon">üí™</span>
                Workout<br><small>+Energy</small>
            </button>
            <button class="activity-btn" data-activity="movie">
                <span class="activity-icon">üé¨</span>
                Watch Movie<br><small>+Love</small>
            </button>
            <button class="activity-btn" data-activity="valorant">
                <span class="activity-icon">üéÆ</span>
                Play Valorant<br><small>+Skills</small>
            </button>
            <button class="activity-btn" data-activity="minecraft">
                <span class="activity-icon">‚õèÔ∏è</span>
                Play Minecraft<br><small>+Creativity</small>
            </button>
            <button class="activity-btn" data-activity="talk">
                <span class="activity-icon">üí¨</span>
                Deep Talk<br><small>+Love</small>
            </button>
        </div>
        <button class="close-info-btn" id="closeActivity">Close</button>
    </div>

    <!-- Item Info Panel -->
    <div id="itemInfoPanel">
        <h3 id="itemInfoTitle">Item Info</h3>
        <div id="itemInfoIcon"></div>
        <div id="itemInfoText"></div>
        <div id="itemInfoGiver"></div>
        <button class="close-info-btn" id="closeItemInfo">Close</button>
    </div>

    <!-- New RPG Panels -->
    
    <!-- Save/Load Menu -->
    <div id="saveMenu" class="rpg-panel" style="display: none;">
        <h2>üíæ Save & Load</h2>
        <div class="save-slots">
            <button class="save-slot-btn" data-slot="1">Slot 1: <span id="save1Info">Empty</span></button>
            <button class="save-slot-btn" data-slot="2">Slot 2: <span id="save2Info">Empty</span></button>
            <button class="save-slot-btn" data-slot="3">Slot 3: <span id="save3Info">Empty</span></button>
        </div>
        <div class="save-actions">
            <button id="quickSave">Quick Save</button>
            <button id="quickLoad">Quick Load</button>
            <button id="closeSaveMenu">Close</button>
        </div>
    </div>

    <!-- Equipment Menu -->
    <div id="equipmentMenu" class="rpg-panel" style="display: none;">
        <h2>üëó Equipment</h2>
        <div class="equipment-tabs">
            <button class="eq-tab active" data-tab="outfits">Outfits</button>
            <button class="eq-tab" data-tab="accessories">Accessories</button>
            <button class="eq-tab" data-tab="pets">Pets</button>
        </div>
        <div id="equipmentList" class="equipment-grid"></div>
        <div class="currency-display">Love Coins: <span id="currencyAmount">100</span></div>
        <button id="closeEquipment">Close</button>
    </div>

    <!-- Skills Menu -->
    <div id="skillsMenu" class="rpg-panel" style="display: none;">
        <h2>üéØ Skills</h2>
        <div class="skill-points">Skill Points: <span id="skillPointsDisplay">0</span></div>
        <div class="skill-trees">
            <div class="skill-category">
                <h3>üç≥ Cooking</h3>
                <div id="cookingSkills" class="skill-list"></div>
            </div>
            <div class="skill-category">
                <h3>üî® Crafting</h3>
                <div id="craftingSkills" class="skill-list"></div>
            </div>
            <div class="skill-category">
                <h3>üíï Social</h3>
                <div id="socialSkills" class="skill-list"></div>
            </div>
            <div class="skill-category">
                <h3>‚ö° Energy</h3>
                <div id="energySkills" class="skill-list"></div>
            </div>
        </div>
        <button id="closeSkills">Close</button>
    </div>

    <!-- Crafting Menu -->
    <div id="craftingMenu" class="rpg-panel" style="display: none;">
        <h2>üî® Crafting</h2>
        <div id="craftingRecipes" class="crafting-grid"></div>
        <button id="closeCrafting">Close</button>
    </div>

    <!-- Cooking Menu -->
    <div id="cookingMenu" class="rpg-panel" style="display: none;">
        <h2>üç≥ Cooking</h2>
        <div id="cookingRecipes" class="cooking-grid"></div>
        <button id="closeCooking">Close</button>
    </div>

    <!-- Gift Shop -->
    <div id="giftShop" class="rpg-panel" style="display: none;">
        <h2>üéÅ Gift Shop</h2>
        <div id="giftItems" class="gift-grid"></div>
        <div class="currency-display">Love Coins: <span id="shopCurrencyAmount">100</span></div>
        <button id="closeGiftShop">Close</button>
    </div>

    <!-- Quick Access Menu -->
    <div id="quickMenu">
        <button class="quick-btn" id="openSave" title="Save/Load">üíæ</button>
        <button class="quick-btn" id="openEquipment" title="Equipment">üëó</button>
        <button class="quick-btn" id="openSkills" title="Skills">üéØ</button>
        <button class="quick-btn" id="openCrafting" title="Crafting">üî®</button>
        <button class="quick-btn" id="openCooking" title="Cooking">üç≥</button>
        <button class="quick-btn" id="openGiftShop" title="Gift Shop">üéÅ</button>
    </div>

    <!-- Status Effects Display -->
    <div id="statusEffects">
        <div id="timeDisplay">üåÖ Morning - Day 1</div>
        <div id="weatherDisplay">‚òÄÔ∏è Clear</div>
        <div id="energyDisplay">‚ö° Energy: 100/100</div>
        <div id="healthDisplay">‚ù§Ô∏è Health: 100/100</div>
    </div>

    <!-- Tutorial Overlay -->
    <div id="tutorialOverlay" style="display: none;">
        <div class="tutorial-box">
            <h2>üí° Tutorial</h2>
            <div id="tutorialText"></div>
            <button id="nextTutorial">Next</button>
            <button id="skipTutorial">Skip Tutorial</button>
        </div>
    </div>

    <!-- Random Event Notification -->
    <div id="randomEventNotif">
        <div id="eventIcon"></div>
        <div id="eventText"></div>
    </div>

    <!-- Loading Screen -->
    <div id="loadScreen">
        <div class="loading-heart" style="left: 10%; animation-delay: 0s;">üíï</div>
        <div class="loading-heart" style="left: 20%; animation-delay: 1s;">üíñ</div>
        <div class="loading-heart" style="left: 30%; animation-delay: 2s;">üíó</div>
        <div class="loading-heart" style="left: 40%; animation-delay: 0.5s;">üíù</div>
        <div class="loading-heart" style="left: 50%; animation-delay: 1.5s;">üíò</div>
        <div class="loading-heart" style="left: 60%; animation-delay: 2.5s;">üíû</div>
        <div class="loading-heart" style="left: 70%; animation-delay: 1s;">üíì</div>
        <div class="loading-heart" style="left: 80%; animation-delay: 2s;">üíó</div>
        <div class="loading-heart" style="left: 90%; animation-delay: 0.8s;">üíï</div>
        
        <h1>CozyBeds Vol.1</h1>
        <div class="instruction">Use WASD or Arrow Keys to Move ‚Ä¢ Click PC for Activities (E) ‚Ä¢ Click ‚öôÔ∏è for Settings</div>
        <div class="loading-bar-container">
            <div class="loading-bar"></div>
        </div>
    </div>

    <!-- RPG UI Elements -->
    <div id="statsPanel">
        <h3>üíñ Diana's Stats</h3>
        <div class="stat-row">
            <span class="stat-label">Level:</span>
            <span class="stat-value" id="playerLevel">1</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">‚ù§Ô∏è Health:</span>
            <div class="progress-bar">
                <div class="progress-fill" id="healthBar" style="width: 100%; background: linear-gradient(90deg, #FF6B9D, #C44569);"></div>
            </div>
        </div>
        <div class="stat-row">
            <span class="stat-label">‚ö° Energy:</span>
            <div class="progress-bar">
                <div class="progress-fill" id="energyBar" style="width: 100%; background: linear-gradient(90deg, #FFE082, #FFD54F);"></div>
            </div>
        </div>
        <div class="stat-row">
            <span class="stat-label">Love:</span>
            <div class="progress-bar">
                <div class="progress-fill" id="loveBar" style="width: 0%"></div>
            </div>
        </div>
        <div class="stat-row">
            <span class="stat-label">Creativity:</span>
            <span class="stat-value" id="creativityStat">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">XP:</span>
            <span class="stat-value"><span id="currentXP">0</span> / <span id="maxXP">100</span></span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Items Found:</span>
            <span class="stat-value" id="itemsFound">0 / 7</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">üí∞ Coins:</span>
            <span class="stat-value" id="coinsStat">100</span>
        </div>
    </div>

    <div id="inventory">
        <h4>üéí Inventory</h4>
        <div class="inventory-grid" id="inventoryGrid"></div>
    </div>

    <div id="achievementNotif">
        <h4>üèÜ Achievement Unlocked!</h4>
        <p id="achievementText">First Steps of Love</p>
    </div>

    <div id="sleepOverlay"></div>
    <div id="sleepMessage">Sweet dreams princess üíïüò¥</div>

    <div id="kissOverlay" class="kiss-overlay"></div>

    <!-- Game Container -->
    <div id="gameContainer">
        <div id="gameBg"></div>
        
        <div id="room">
            <div class="romantic-glow"></div>
            <div class="weather-container" id="weatherContainer"></div>
            
            <img id="bed" class="room-item" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/room%20items/bed.png" alt="Bed">
            <div id="bedHint">Click to Sleep Together üò¥üíï</div>
            <img id="pcTable" class="room-item" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/room%20items/pc_table.png" alt="PC Table" title="Click to choose activities (or press E)">
            <img id="gamingChair" class="room-item" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/room%20items/gaming_chair.png" alt="Gaming Chair">
            <img id="rightSideTable" class="room-item" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/room%20items/right_side_table.png" alt="Side Table">

            <img id="teddybear" class="item" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/items/teddybear.png" alt="Teddy Bear">
            <img id="flower" class="item" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/items/flower.png" alt="Flower">
            <img id="giftbox" class="item" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/items/gifbox.png" alt="Gift Box">
            <img id="steak" class="item" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/items/steak.png" alt="Steak">
            <img id="cake" class="item" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/items/cake.png" alt="Cake">
            <img id="wine" class="item" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/items/wine.png" alt="Wine">
            <img id="letter" class="item" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/items/letter.png" alt="Letter" style="display: none;">

            <div id="her" class="character">
                <img id="herSprite" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/her/front_stand.png">
                <div id="herName" class="player-name">Diana</div>
            </div>
            
            <div id="him" class="character">
                <img id="himSprite" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/him/idle1.png">
                <div id="himName" class="player-name">Amon</div>
                <div id="proximityHint">Press Click to Kiss üíã</div>
            </div>
        </div>
    </div>

    <!-- Textbox -->
    <div id="textboxContainer">
        <img id="textboxBg" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/textbox/textbox.png" alt="Textbox">
        <div id="textboxContent">
            <img id="avatarImg" src="https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/talk_popup/him.png" alt="Avatar">
            <div id="dialogText"></div>
        </div>
        <button id="continueBtn" onclick="playSound('click')">Continue</button>
    </div>

    <!-- Dialogue Choices -->
    <div id="dialogueChoices"></div>

    <!-- Quest Indicator -->
    <div id="questIndicator">
        <h3>üíù Quest List</h3>
        <div id="questList"></div>
    </div>

<script>
        // Game settings
        let isMuted = false;
        let lastClickTime = 0;
        const CLICK_DEBOUNCE = 300; // milliseconds

        // Sound System using Howler.js (CDN)
        const sounds = {
            click: 'https://cdn.freesound.org/previews/221/221683_4245266-lq.mp3',
            collect: 'https://cdn.freesound.org/previews/341/341695_5858296-lq.mp3',
            success: 'https://cdn.freesound.org/previews/270/270319_5123851-lq.mp3',
            dialogue: 'https://cdn.freesound.org/previews/249/249701_4354933-lq.mp3',
            ambient: 'https://cdn.freesound.org/previews/523/523609_6976839-lq.mp3'
        };

        // Simple sound player with mute check
        function playSound(type) {
            if (isMuted) return;
            
            // Prevent sound stacking
            const now = Date.now();
            if (type === 'collect' && now - lastClickTime < CLICK_DEBOUNCE) {
                return;
            }
            if (type === 'collect') {
                lastClickTime = now;
            }
            
            try {
                const audio = new Audio(sounds[type]);
                audio.volume = 0.3;
                audio.play().catch(e => console.log('Audio play prevented:', e));
            } catch (e) {
                console.log('Sound error:', e);
            }
        }

        // Play ambient sound on user interaction
        let ambientPlaying = false;
        let ambientAudio = null;
        function playAmbient() {
            if (!ambientPlaying && !isMuted) {
                try {
                    ambientAudio = new Audio(sounds.ambient);
                    ambientAudio.volume = 0.1;
                    ambientAudio.loop = true;
                    ambientAudio.play().catch(e => console.log('Ambient prevented:', e));
                    ambientPlaying = true;
                } catch (e) {
                    console.log('Ambient error:', e);
                }
            }
        }

        // Mute toggle functionality
        document.getElementById('muteToggle').addEventListener('click', function() {
            isMuted = !isMuted;
            this.classList.toggle('active');
            
            // Stop or resume ambient
            if (isMuted && ambientAudio) {
                ambientAudio.pause();
            } else if (!isMuted && ambientAudio) {
                ambientAudio.play();
            }
            
            playSound('click');
        });

        // Theme Settings
        const themes = {
            default: {
                filter: 'none',
                weather: null
            },
            snow: {
                filter: 'brightness(1.1) saturate(0.8) hue-rotate(180deg)',
                weather: 'snow'
            },
            rain: {
                filter: 'brightness(0.7) saturate(0.9) hue-rotate(180deg)',
                weather: 'rain'
            },
            sunny: {
                filter: 'brightness(1.3) saturate(1.1) contrast(0.9)',
                weather: null
            },
            cherry: {
                filter: 'brightness(1.1) saturate(1.1) hue-rotate(180deg)',
                weather: 'petals'
            }
        };

        let currentTheme = 'default';
        let idleTimer = null;
        let idleWarningShown = false;
        let kissRefusalCount = 0;
        let sleepRefusalCount = 0;

        // Weather System
        function createWeather(type) {
            const container = document.getElementById('weatherContainer');
            container.innerHTML = '';

            if (!type) return;

            const count = type === 'rain' ? 100 : 50;

            for (let i = 0; i < count; i++) {
                const element = document.createElement('div');
                element.className = type === 'snow' ? 'snowflake' : type === 'rain' ? 'raindrop' : 'petal';
                
                if (type === 'snow') {
                    element.textContent = '‚ùÑ';
                    element.style.left = Math.random() * 100 + '%';
                    element.style.animationDelay = Math.random() * 10 + 's';
                    element.style.fontSize = (10 + Math.random() * 20) + 'px';
                } else if (type === 'rain') {
                    element.style.left = Math.random() * 100 + '%';
                    element.style.animationDelay = Math.random() * 1 + 's';
                    element.style.animationDuration = (0.5 + Math.random() * 0.5) + 's';
                } else if (type === 'petals') {
                    element.style.left = Math.random() * 100 + '%';
                    element.style.animationDelay = Math.random() * 12 + 's';
                }

                container.appendChild(element);
            }
        }

        // Apply Theme
        function applyTheme(themeName) {
            const theme = themes[themeName];
            const room = document.getElementById('room');
            const gameContainer = document.getElementById('gameContainer');

            room.style.filter = theme.filter;
            gameContainer.style.filter = theme.filter;

            createWeather(theme.weather);

            currentTheme = themeName;

            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === themeName) {
                    btn.classList.add('active');
                }
            });
        }

        // Settings Panel Toggle
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settingsPanel').classList.add('show');
        });

        document.getElementById('closeSettings').addEventListener('click', () => {
            document.getElementById('settingsPanel').classList.remove('show');
        });

        // Activity Panel functionality
        document.getElementById('closeActivity').addEventListener('click', () => {
            playSound('click');
            document.getElementById('activityPanel').classList.remove('show');
            gameState.canMove = true;
        });

        document.querySelectorAll('.activity-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const activity = btn.dataset.activity;
                playSound('click');
                document.getElementById('activityPanel').classList.remove('show');
                performActivity(activity);
            });
        });

        function showActivityPanel() {
            if (gameState.dialogueActive || gameState.isSleeping) return;
            playSound('click');
            document.getElementById('activityPanel').classList.add('show');
            gameState.canMove = false;
        }

        function performActivity(activity) {
            gameState.dailyActivitiesDone++;
            
            // Complete the do_activity quest on first activity
            if (!quests.find(q => q.id === 'do_activity').completed) {
                completeQuest('do_activity');
            }
            
            switch(activity) {
                case 'drawing':
                    rpgStats.creativity += 10;
                    addXP(20);
                    showDialog("MmMMM flowers :D", 'her', false);
                    setTimeout(hideDialog, 2500);
                    break;
                case 'watch a documentary':
                    rpgStats.intelligence += 10;
                    addXP(20);
                    showDialog("WANNA HEAR SOMETHING I LEARNED?", 'her', false);
                    setTimeout(hideDialog, 2500);
                    break;
                case 'workout':
                    rpgStats.energy += 10;
                    addXP(20);
                    showDialog("Well. Done with that I guess?", 'her', false);
                    setTimeout(hideDialog, 2500);
                    break;
                case 'movie':
                    watchMovieSequence();
                    break;
                case 'valorant':
                    playValorantSequence();
                    break;
                case 'minecraft':
                    playMinecraftSequence();
                    break;
                case 'talk':
                    deepTalkSequence();
                    break;
            }
            
            updateStatsUI();
        }

        function playValorantSequence() {
            showDialog("Pls don't rage quit", 'him', false);
            setTimeout(() => {
                hideDialog();
                setTimeout(() => {
                    showDialogueChoices('valorant', [
                        { 
                            text: 'Play Penix', 
                            class: 'flirty',
                            response: "IM GONNA FLASH MY TEAM",
                            callback: () => {
                                showDialog("THATS MY GIRL", 'him', false);
                                setTimeout(() => {
                                    hideDialog();
                                    rpgStats.skills += 15;
                                    addXP(25);
                                    addLove(10);
                                    updateStatsUI();
                                    setTimeout(() => {
                                        showDialog("Good job on your 9 kills in swift ma'am", 'him', false);
                                        setTimeout(hideDialog, 2500);
                                    }, 1000);
                                }, 2500);
                            }
                        },
                        { 
                            text: 'Play Omen', 
                            class: 'playful',
                            response: "I WILL FLASH MY TEAM AGAIN",
                            callback: () => {
                                showDialog("Pls don't smoke that spot", 'him', false);
                                setTimeout(() => {
                                    hideDialog();
                                    rpgStats.skills += 10;
                                    addXP(20);
                                    addLove(15);
                                    updateStatsUI();
                                    setTimeout(() => {
                                        showDialog("... I hate this game", 'him', false);
                                        setTimeout(hideDialog, 2500);
                                    }, 1000);
                                }, 2500);
                            }
                        }
                    ]);
                }, 500);
            }, 2500);
        }

        function playMinecraftSequence() {
            showDialog("What chicken are you killin' this time?", 'him', false);
            setTimeout(() => {
                hideDialog();
                setTimeout(() => {
                    showDialogueChoices('minecraft', [
                        { 
                            text: 'Chicken 1', 
                            class: 'flirty',
                            response: "YOU NAMED IT?",
                            callback: () => {
                                showDialog("Wow...", 'him', false);
                                setTimeout(() => {
                                    hideDialog();
                                    rpgStats.creativity += 20;
                                    addXP(25);
                                    addLove(15);
                                    updateStatsUI();
                                    setTimeout(() => {
                                        showDialog("STOP DYING", 'him', false);
                                        setTimeout(hideDialog, 2500);
                                    }, 1000);
                                }, 2500);
                            }
                        },
                        { 
                            text: 'Go slave in the mines', 
                            class: 'playful',
                            response: "Pls i need a diamond hat",
                            callback: () => {
                                showDialog("uh oh, why dia hat?", 'him', false);
                                setTimeout(() => {
                                    hideDialog();
                                    rpgStats.skills += 10;
                                    rpgStats.creativity += 10;
                                    addXP(20);
                                    addLove(10);
                                    updateStatsUI();
                                    setTimeout(() => {
                                        showDialog("... that creeper was infront of you...", 'him', false);
                                        setTimeout(hideDialog, 2500);
                                    }, 1000);
                                }, 2500);
                            }
                        }
                    ]);
                }, 500);
            }, 2500);
        }

        function deepTalkSequence() {
            const talkTopics = [
                {
                    question: "What's on your mind baby'",
                    options: [
                        {
                            text: "EVIL DOLPHINS",
                            response: "I think they're like the trumps of the sea lowk",
                            reply: "Uh-huh"
                        },
                        {
                            text: "Wanna hear about Russia and why it's such a great place but shitty gov?üë©‚Äçüëß",
                            response: "{insert diana responses}",
                            reply: "We could watch a documentary about it with animations?"
                        },
                        {
                            text: "I think I can outrun the pope if there was a zombie apocalypse",
                            response: "No I'm deadass, I can outrun that hoe",
                            reply: "Uh... You're blind???"
                        }
                    ]
                },
                {
                    question: "Yk what's on my mind baby?",
                    options: [
                        {
                            text: "MALE HORSIE :)",
                            response: "My little horsie",
                            reply: "STOP ASSAULTING MY PIXEL INTERNALS LIKE THAT"
                        },
                        {
                            text: "I think I can outrun you",
                            response: "You have asthma, soooo",
                            reply: "Asthmophobic bitch"
                        },
                        {
                            text: "Pelmeni",
                            response: "I'm hungry :(",
                            reply: "I'll cook for you"
                        }
                    ]
                }
            ];
            
            const topic = talkTopics[Math.floor(Math.random() * talkTopics.length)];
            
            showDialog(topic.question, 'him', false);
            setTimeout(() => {
                hideDialog();
                setTimeout(() => {
                    showDialogueChoices('deep_talk', topic.options.map(opt => ({
                        text: opt.text,
                        class: 'flirty',
                        response: opt.response,
                        callback: () => {
                            showDialog(opt.reply, 'him', false);
                            setTimeout(() => {
                                hideDialog();
                                addLove(20);
                                addXP(30);
                                updateStatsUI();
                            }, 3000);
                        }
                    })));
                }, 500);
            }, 2500);
        }

        function watchMovieSequence() {
            // Movie selection dialogue
            showDialog("Want to watch a movie with me, baby?", 'him', false);
            setTimeout(() => {
                hideDialog();
                setTimeout(() => {
                    showDialogueChoices('movie_choice', [
                        { 
                            text: 'Horror Movie üëª', 
                            class: 'playful',
                            response: "I miiiight punch you",
                            callback: () => {
                                playMovieScene('horror');
                            }
                        },
                        { 
                            text: 'Romance Movie üíï', 
                            class: 'flirty',
                            response: "You do lowkey remind me of the male lead baby",
                            callback: () => {
                                playMovieScene('romance');
                            }
                        },
                        { 
                            text: 'Comedy Movie üòÇ', 
                            class: 'playful',
                            response: "I wanna hate on others stupidity please",
                            callback: () => {
                                playMovieScene('comedy');
                            }
                        },
                        { 
                            text: 'Action Movie üí•', 
                            class: 'playful',
                            response: "I think I could outrun a bomb",
                            callback: () => {
                                playMovieScene('action');
                            }
                        },
                        { 
                            text: 'Anime üéå', 
                            class: 'flirty',
                            response: "I DON'T REMEMBER THE NAME BUT IT HAD GOOD PLOT",
                            callback: () => {
                                playMovieScene('anime');
                            }
                        },
                        { 
                            text: 'Sci-Fi üöÄ', 
                            class: 'playful',
                            response: "Can we watch something realistic though?",
                            callback: () => {
                                playMovieScene('scifi');
                            }
                        }
                    ]);
                }, 500);
            }, 2500);
        }

        function playMovieScene(movieType) {
            const cinematicFade = document.getElementById('cinematicFade');
            const choicesContainer = document.getElementById('dialogueChoices');
            
            // Hide dialogue choices immediately
            choicesContainer.classList.remove('show');
            
            // Complete watch_movie quest
            if (!quests.find(q => q.id === 'watch_movie').completed) {
                completeQuest('watch_movie');
            }
            
            // Fade to black
            cinematicFade.classList.remove('fade-out');
            cinematicFade.classList.add('fade-in');
            
            setTimeout(() => {
                // Movie is "playing" (black screen)
                const movieDialogues = {
                    horror: {
                        him: "Wanna cuddle?",
                        her: "I need to piss"
                    },
                    romance: {
                        him: "That was sum",
                        her: "Do you hate me?"
                    },
                    comedy: {
                        him: "Clown ahh",
                        her: "bro you literally act the saame way as the clown"
                    },
                    action: {
                        him: "Yeah you def are not outrunning that bomb",
                        her: "..."
                    },
                    anime: {
                        him: "I wanna eat that food",
                        her: "Fat bastard"
                    },
                    scifi: {
                        him: "I don't think I like insterstellar?",
                        her: "I need to piss... again..."
                    }
                };
                
                const dialogue = movieDialogues[movieType];
                
                // Fade back in after "movie"
                setTimeout(() => {
                    cinematicFade.classList.remove('fade-in');
                    cinematicFade.classList.add('fade-out');
                    
                    setTimeout(() => {
                        // Post-movie commentary
                        showDialog(dialogue.him, 'him', false);
                        setTimeout(() => {
                            hideDialog();
                            setTimeout(() => {
                                showDialog(dialogue.her, 'her', false);
                                setTimeout(() => {
                                    hideDialog();
                                    gameState.watchedMovie = true;
                                    addLove(15);
                                    addXP(25);
                                    updateStatsUI();
                                }, 2500);
                            }, 500);
                        }, 2500);
                    }, 1000);
                }, 3000); // Movie duration
            }, 2000);
        }

        // Theme Button Handlers
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                applyTheme(btn.dataset.theme);
            });
        });

        // Enhanced Dialogue System with Specific Conversations
        function showDialogueChoices(context = 'general', responses) {
            const choicesContainer = document.getElementById('dialogueChoices');
            choicesContainer.innerHTML = '';

            responses.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = `choice-btn ${choice.class}`;
                btn.textContent = choice.text;
                btn.addEventListener('click', () => {
                    playSound('click');
                    selectDialogueChoice(choice.response, choice.callback);
                });
                choicesContainer.appendChild(btn);
            });

            choicesContainer.classList.add('show');
            playSound('dialogue');
        }

        function selectDialogueChoice(herResponse, callback) {
            const choicesContainer = document.getElementById('dialogueChoices');
            choicesContainer.classList.remove('show');

            // Show Her response
            showDialog(herResponse, 'her', false);

            // Execute callback after her response (auto-progress)
            if (callback) {
                setTimeout(() => {
                    hideDialog();
                    setTimeout(() => {
                        callback();
                    }, 500);
                }, 2500); // Auto-close after 2.5 seconds
            }
        }

        // Start idle timer to check if player is roaming without collecting
        function startIdleTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                if (gameState.itemsCollected.length === 0 && !idleWarningShown) {
                    idleWarningShown = true;
                    showDialog("omg Diana just start the gameeeee", 'him', false);
                    setTimeout(() => {
                        hideDialog();
                        setTimeout(() => {
                            showDialogueChoices('idle', [
                                { 
                                    text: 'Be Flirty üíï', 
                                    class: 'flirty',
                                    response: "I nono wanna I'm admiring your work",
                                    callback: () => {
                                        showDialog("YOU HAVE HOURS AND DAYS TO DO START THE GAME!!!!", 'him', false);
                                        setTimeout(hideDialog, 2500);
                                    }
                                },
                                { 
                                    text: 'Be Sarcastic üòè', 
                                    class: 'sarcastic',
                                    response: "IF YOU MADE IT MORE OBVIOUS WHERE TO CLICK?",
                                    callback: () => {
                                        showDialog("The glowing items maybe? HHMMMM?", 'him', false);
                                        setTimeout(hideDialog, 2500);
                                    }
                                },
                                { 
                                    text: 'Be Mean üò§', 
                                    class: 'mean',
                                    response: "You do it then npc bitch",
                                    callback: () => {
                                        showDialog("WHO YOU CALLING NPC YOU PIXELATED DICKHEAD", 'him', false);
                                        setTimeout(hideDialog, 2500);
                                    }
                                }
                            ]);
                        }, 500);
                    }, 2500);
                }
            }, 10000); // 10 seconds
        }

        // RPG Stats System - Enhanced
        const rpgStats = {
            level: 1,
            xp: 0,
            maxXp: 100,
            love: 0,
            maxLove: 100,
            creativity: 0,
            intelligence: 0,
            energy: 100,
            maxEnergy: 100,
            health: 100,
            maxHealth: 100,
            skills: 0,
            skillPoints: 0,
            achievements: [],
            inventory: [],
            equipment: {
                outfit: null,
                accessory: null,
                pet: null
            },
            relationship: {
                affection: 0,
                trust: 0,
                romance: 0
            },
            currency: 100, // Love coins
            craftingMaterials: {},
            unlockedSkills: [],
            completedEvents: []
        };

        const CHARACTER_HITBOX = {
            her: { width: 45, height: 120, offsetX: 22, offsetY: 15 },
            him: { width: 42, height: 120, offsetX: 21, offsetY: 15 }
        };

        const collisionBoxes = [
            { x: 90, y: 156, width: 156, height: 280, name: 'bed' },
            { x: 438, y: 180, width: 390, height: 150, name: 'pcTable' },
            { x: 547, y: 290, width: 96, height: 100, name: 'chair' },
            { x: 573, y: 120, width: 165, height: 300, name: 'sideTable' }
        ];

        const gameState = {
            itemsCollected: [],
            herPosition: { x: 350, y: 250 },
            herDirection: 'front',
            canMove: true,
            allItemsCollected: false,
            kissAnimating: false,
            walkFrame: 1,
            frameCounter: 0,
            isNearHim: false,
            isNearBed: false,
            isSleeping: false,
            allQuestsComplete: false,
            himPosition: { x: 464, y: 240 },
            dialogueActive: false,
            watchedMovie: false,
            dailyActivitiesDone: 0,
            // New RPG features
            currentDay: 1,
            timeOfDay: 'morning', // morning, afternoon, evening, night
            weather: 'clear', // clear, rain, snow, sunny, cherry
            currentRoom: 'bedroom', // bedroom, kitchen, garden, etc
            tutorialComplete: false,
            difficulty: 'normal', // easy, normal, hard
            autoSaveEnabled: true,
            lastSaveTime: null,
            randomEventCooldown: 0,
            petHappiness: 50,
            gardenPlants: []
        };

        const quests = [
            { id: 'teddybear', name: 'Find the Teddy Bear üß∏', completed: false, xp: 15 },
            { id: 'flower', name: 'Find the Flower üå∏', completed: false, xp: 15 },
            { id: 'giftbox', name: 'Find the Gift Box üéÅ', completed: false, xp: 15 },
            { id: 'steak', name: 'Find the Steak ü•©', completed: false, xp: 15 },
            { id: 'cake', name: 'Find the Cake üç∞', completed: false, xp: 15 },
            { id: 'wine', name: 'Find the Wine üç∑', completed: false, xp: 15 },
            { id: 'letter', name: 'Read the Letter üíå', completed: false, xp: 20 },
            { id: 'talk_to_him', name: 'Have a conversation with Amon üí¨', completed: false, xp: 10 },
            { id: 'do_activity', name: 'Complete a daily activity üé®', completed: false, xp: 15 },
            { id: 'watch_movie', name: 'Watch a movie together üé¨', completed: false, xp: 25 },
            { id: 'kiss', name: 'Kiss Him üíã', completed: false, xp: 30 },
            { id: 'sleep', name: 'Sleep Together üò¥', completed: false, xp: 50 }
        ];

        const achievements = [
            { id: 'first_item', name: 'Treasure Hunter', desc: 'Find your first item', icon: 'üîç' },
            { id: 'half_items', name: 'Halfway There', desc: 'Collect 3 items', icon: '‚≠ê' },
            { id: 'all_items', name: 'Collector', desc: 'Find all items', icon: 'üíé' },
            { id: 'first_kiss', name: 'First Kiss', desc: 'Share your first kiss', icon: 'üíã' },
            { id: 'level_2', name: 'Growing Love', desc: 'Reach level 2', icon: 'üìà' },
            { id: 'level_3', name: 'Deep Connection', desc: 'Reach level 3', icon: 'üí™' },
            { id: 'max_love', name: 'Endless Love', desc: 'Fill the love meter', icon: 'üíñ' },
            { id: 'explorer', name: 'Explorer', desc: 'Walk 1000 steps', icon: 'üë£' },
            { id: 'night_owl', name: 'Night Owl', desc: 'Play past midnight', icon: 'ü¶â' },
            { id: 'sweet_dreams', name: 'Sweet Dreams', desc: 'Sleep together', icon: 'üò¥' },
            { id: 'speed_runner', name: 'Speed Runner', desc: 'Complete all quests in under 10 minutes', icon: '‚ö°' },
            { id: 'perfect_love', name: 'Perfect Love', desc: 'Complete everything', icon: 'üëë' },
            // New achievements
            { id: 'master_chef', name: 'Master Chef', desc: 'Cook 10 meals', icon: 'üë®‚Äçüç≥' },
            { id: 'crafter', name: 'Crafter', desc: 'Craft 5 items', icon: 'üî®' },
            { id: 'gift_giver', name: 'Gift Giver', desc: 'Give 5 gifts', icon: 'üéÄ' },
            { id: 'fashionista', name: 'Fashionista', desc: 'Collect all outfits', icon: 'üëó' },
            { id: 'pet_lover', name: 'Pet Lover', desc: 'Keep pet happiness above 80', icon: 'üê±' },
            { id: 'gardener', name: 'Gardener', desc: 'Grow 10 plants', icon: 'üå±' },
            { id: 'max_level', name: 'Max Level', desc: 'Reach level 10', icon: '‚≠ê' },
            { id: 'skill_master', name: 'Skill Master', desc: 'Unlock all skills', icon: 'üéØ' }
        ];

        const itemMessages = {
            teddybear: "I will always cherish the kid in you that never got to be loved properly",
            flower: "I will always make sure you bloom pretty like your mother intended you to",
            giftbox: "Consider this as me making it up for your birthday princess",
            steak: "Can't forget your cravings baby :D",
            cake: "To growing old with you, best blessing I've gotten",
            wine: "To enjoying you timely, I'll be always here",
            letter: "And at last, in so many different words, I'll choose a simplified version, I love you to the moon and back my pretty girl."
        };

        const itemIcons = {
            teddybear: 'üß∏',
            flower: 'üå∏',
            giftbox: 'üéÅ',
            steak: 'ü•©',
            cake: 'üç∞',
            wine: 'üç∑',
            letter: 'üíå'
        };

        // Equipment System
        const equipment = {
            outfits: [
                { id: 'default', name: 'Casual Outfit', bonus: { energy: 0 }, cost: 0, owned: true },
                { id: 'elegant', name: 'Elegant Dress', bonus: { love: 10 }, cost: 200, owned: false },
                { id: 'sporty', name: 'Sporty Outfit', bonus: { energy: 20 }, cost: 150, owned: false },
                { id: 'cute', name: 'Cute Pajamas', bonus: { creativity: 10 }, cost: 100, owned: false }
            ],
            accessories: [
                { id: 'bow', name: 'Hair Bow', bonus: { love: 5 }, cost: 50, owned: false },
                { id: 'necklace', name: 'Heart Necklace', bonus: { romance: 10 }, cost: 150, owned: false },
                { id: 'bracelet', name: 'Charm Bracelet', bonus: { luck: 5 }, cost: 100, owned: false }
            ],
            pets: [
                { id: 'cat', name: 'Fluffy Cat', bonus: { happiness: 10 }, cost: 300, owned: false },
                { id: 'dog', name: 'Loyal Dog', bonus: { energy: 15 }, cost: 300, owned: false },
                { id: 'bunny', name: 'Cute Bunny', bonus: { love: 10 }, cost: 250, owned: false }
            ]
        };

        // Skill Tree System
        const skillTree = {
            cooking: [
                { id: 'basic_cooking', name: 'Basic Cooking', desc: 'Unlock cooking mini-game', cost: 1, unlocked: false },
                { id: 'advanced_cooking', name: 'Advanced Cooking', desc: 'Cook advanced recipes', cost: 2, unlocked: false, requires: 'basic_cooking' },
                { id: 'master_chef', name: 'Master Chef', desc: '+50% cooking speed', cost: 3, unlocked: false, requires: 'advanced_cooking' }
            ],
            crafting: [
                { id: 'basic_crafting', name: 'Basic Crafting', desc: 'Unlock crafting system', cost: 1, unlocked: false },
                { id: 'advanced_crafting', name: 'Advanced Crafting', desc: 'Craft rare items', cost: 2, unlocked: false, requires: 'basic_crafting' }
            ],
            social: [
                { id: 'charmer', name: 'Charmer', desc: '+20% affection gain', cost: 1, unlocked: false },
                { id: 'romantic', name: 'Romantic', desc: 'Unlock romantic dialogues', cost: 2, unlocked: false, requires: 'charmer' }
            ],
            energy: [
                { id: 'energized', name: 'Energized', desc: '+20 max energy', cost: 1, unlocked: false },
                { id: 'tireless', name: 'Tireless', desc: 'Energy drains 50% slower', cost: 2, unlocked: false, requires: 'energized' }
            ]
        };

        // Crafting Recipes
        const craftingRecipes = [
            { id: 'love_letter', name: 'Love Letter', materials: { paper: 1, ink: 1 }, result: 'love_letter', affection: 15 },
            { id: 'photo_frame', name: 'Photo Frame', materials: { wood: 2, glass: 1 }, result: 'photo_frame', affection: 25 },
            { id: 'bracelet', name: 'Handmade Bracelet', materials: { thread: 2, beads: 3 }, result: 'bracelet', affection: 20 },
            { id: 'scrapbook', name: 'Memory Scrapbook', materials: { paper: 5, photos: 3, glue: 1 }, result: 'scrapbook', affection: 40 }
        ];

        // Cooking Recipes  
        const cookingRecipes = [
            { id: 'pancakes', name: 'Heart Pancakes', ingredients: { flour: 2, eggs: 1, milk: 1 }, energy: 20, love: 5 },
            { id: 'pasta', name: 'Romantic Pasta', ingredients: { pasta: 1, sauce: 1, cheese: 1 }, energy: 30, love: 10 },
            { id: 'cake', name: 'Love Cake', ingredients: { flour: 3, eggs: 2, sugar: 2, butter: 1 }, energy: 40, love: 20 },
            { id: 'cookies', name: 'Heart Cookies', ingredients: { flour: 2, sugar: 1, butter: 1 }, energy: 15, love: 8 }
        ];

        // Gift System
        const giftItems = [
            { id: 'rose', name: 'Red Rose', cost: 50, affection: 10, romance: 5 },
            { id: 'chocolate', name: 'Chocolates', cost: 75, affection: 15, love: 10 },
            { id: 'plushie', name: 'Cute Plushie', cost: 100, affection: 20, happiness: 10 },
            { id: 'jewelry', name: 'Jewelry', cost: 250, affection: 40, romance: 20 },
            { id: 'perfume', name: 'Perfume', cost: 150, affection: 25, romance: 15 }
        ];

        // Random Events
        const randomEvents = [
            { id: 'surprise_gift', name: 'Surprise Gift', desc: 'Found a surprise gift!', reward: { currency: 50 }, chance: 0.1 },
            { id: 'energy_boost', name: 'Energy Boost', desc: 'Feeling energized!', reward: { energy: 30 }, chance: 0.15 },
            { id: 'romantic_moment', name: 'Romantic Moment', desc: 'A sweet moment together', reward: { romance: 20 }, chance: 0.1 },
            { id: 'found_material', name: 'Found Material', desc: 'Found crafting materials!', reward: { randomMaterial: 1 }, chance: 0.2 }
        ];

        // Time-based events
        const timeEvents = {
            morning: { energyRegen: 2, mood: 'fresh' },
            afternoon: { energyRegen: 1, mood: 'active' },
            evening: { energyRegen: 1, mood: 'romantic' },
            night: { energyRegen: 0, mood: 'cozy' }
        };

        const itemInfo = {
            teddybear: {
                name: 'Teddy Bear',
                description: 'Me, this is me baby.',
                giver: 'From: Amon üíï',
                message: "I will always cherish the kid in you that never got to be loved properly"
            },
            flower: {
                name: 'Beautiful Flower',
                description: 'Pls dont eat it',
                giver: 'From: Amon üíï',
                message: "I will always make sure you bloom pretty like your mother intended you to"
            },
            giftbox: {
                name: 'Gift Box',
                description: 'It has me inside it',
                giver: 'From: Amon üíï',
                message: "Consider this as me making it up for your birthday princess"
            },
            steak: {
                name: 'Delicious Steak',
                description: 'Always for your cravings',
                giver: 'From: Amon üíï',
                message: "Can't forget your cravings baby :D"
            },
            cake: {
                name: 'Sweet Cake',
                description: 'Strawberry charlotte, trust.',
                giver: 'From: Amon üíï',
                message: "To growing old with you, best blessing I've gotten"
            },
            wine: {
                name: 'Fine Wine',
                description: 'Its lambrusco',
                giver: 'From: Amon üíï',
                message: "To enjoying you timely, I'll be always here"
            },
            letter: {
                name: 'Love Letter',
                description: 'A heartfelt letter expressing deep feelings.',
                giver: 'From: Amon üíï',
                message: "And at last, in so many different words, I'll choose a simplified version, I love you to the moon and back my pretty girl."
            }
        };

        // Initialize with cinematic fade-in
        window.addEventListener('load', () => {
            // Cinematic fade out from black
            setTimeout(() => {
                document.getElementById('cinematicFade').classList.add('fade-out');
            }, 500);

            setTimeout(() => {
                document.getElementById('loadScreen').classList.add('hidden');
                setTimeout(startGame, 500);
            }, 2500);
        });

        function startGame() {
            playAmbient();
            updateQuestUI();
            updateStatsUI();
            initializeInventory();
            startHimIdleAnimation();
            createRomanticParticles();
            updatePlayerNames();
            
            // Initial greeting dialogue
            setTimeout(() => {
                showDialog("Finally you fucking loaded, I've been waiting for ages turtle ahh.", 'him', false);
                setTimeout(() => {
                    hideDialog();
                    setTimeout(() => {
                        showDialogueChoices('greeting', [
                            { 
                                text: 'Be Flirty üíï', 
                                class: 'flirty',
                                response: "Sorry I was getting pretty before loading",
                                callback: () => {
                                    showDialog("You're gonna stain my pixel bed with glitter too???", 'him', false);
                                    setTimeout(() => {
                                        hideDialog();
                                        completeQuest('talk_to_him');
                                        setTimeout(() => {
                                            showTutorialHint();
                                        }, 1000);
                                        startIdleTimer();
                                    }, 2500);
                                }
                            },
                            { 
                                text: 'Be Sarcastic üòè', 
                                class: 'sarcastic',
                                response: "You coded it well enough for me to load so fast :)",
                                callback: () => {
                                    showDialog("Yeah ma'am", 'him', false);
                                    setTimeout(() => {
                                        hideDialog();
                                        completeQuest('talk_to_him');
                                        setTimeout(() => {
                                            showTutorialHint();
                                        }, 1000);
                                        startIdleTimer();
                                    }, 2500);
                                }
                            },
                            { 
                                text: 'Be Mean üò§', 
                                class: 'mean',
                                response: "Shut up dumbass",
                                callback: () => {
                                    showDialog("You're so cute", 'him', false);
                                    setTimeout(() => {
                                        hideDialog();
                                        completeQuest('talk_to_him');
                                        setTimeout(() => {
                                            showTutorialHint();
                                        }, 1000);
                                        startIdleTimer();
                                    }, 2500);
                                }
                            }
                        ]);
                    }, 500);
                }, 2500);
            }, 2000);
        }

        function showTutorialHint() {
            showDialog("Alright, explore the room and find all the items I left for you. Use WASD to move around, and click the PC desk (or press E) if you want to do activities together! üíï", 'him', false);
            setTimeout(hideDialog, 4000);
        }

        function updateStatsUI() {
            document.getElementById('playerLevel').textContent = rpgStats.level;
            document.getElementById('currentXP').textContent = rpgStats.xp;
            document.getElementById('maxXP').textContent = rpgStats.maxXp;
            document.getElementById('loveBar').style.width = (rpgStats.love / rpgStats.maxLove * 100) + '%';
            document.getElementById('itemsFound').textContent = gameState.itemsCollected.length + ' / 7';
            document.getElementById('creativityStat').textContent = rpgStats.creativity;
            
            // Update new stats
            document.getElementById('healthBar').style.width = (rpgStats.health / rpgStats.maxHealth * 100) + '%';
            document.getElementById('energyBar').style.width = (rpgStats.energy / rpgStats.maxEnergy * 100) + '%';
            document.getElementById('coinsStat').textContent = rpgStats.currency;
            document.getElementById('currencyAmount').textContent = rpgStats.currency;
            document.getElementById('shopCurrencyAmount').textContent = rpgStats.currency;
            document.getElementById('skillPointsDisplay').textContent = rpgStats.skillPoints;
            
            // Update time/weather display
            updateTimeDisplay();
        }

        function addXP(amount) {
            rpgStats.xp += amount;
            
            if (rpgStats.xp >= rpgStats.maxXp) {
                levelUp();
            }
            
            updateStatsUI();
        }

        function levelUp() {
            rpgStats.level++;
            rpgStats.xp -= rpgStats.maxXp;
            rpgStats.maxXp = Math.floor(rpgStats.maxXp * 1.5);
            rpgStats.skillPoints += 1; // Gain skill point on level up
            rpgStats.maxHealth += 10; // Increase max health
            rpgStats.maxEnergy += 10; // Increase max energy
            rpgStats.health = rpgStats.maxHealth; // Full heal on level up
            rpgStats.energy = rpgStats.maxEnergy; // Full energy on level up
            
            playSound('success');
            const levelUpEffect = document.createElement('div');
            levelUpEffect.className = 'levelup-effect';
            levelUpEffect.textContent = `LEVEL ${rpgStats.level}!`;
            document.body.appendChild(levelUpEffect);
            
            setTimeout(() => levelUpEffect.remove(), 2000);
            
            if (rpgStats.level === 2) unlockAchievement('level_2');
            if (rpgStats.level === 3) unlockAchievement('level_3');
            if (rpgStats.level === 10) unlockAchievement('max_level');
            
            showNotification(`Level Up! You're now level ${rpgStats.level}! +1 Skill Point`, '‚≠ê');
            
            updateStatsUI();
        }

        function addLove(amount) {
            rpgStats.love = Math.min(rpgStats.maxLove, rpgStats.love + amount);
            
            if (rpgStats.love >= rpgStats.maxLove) {
                unlockAchievement('max_love');
            }
            
            updateStatsUI();
        }

        function unlockAchievement(achievementId, showNotif = true) {
            if (rpgStats.achievements.includes(achievementId)) return;
            
            rpgStats.achievements.push(achievementId);
            const achievement = achievements.find(a => a.id === achievementId);
            
            if (showNotif && achievement) {
                playSound('success');
                const notif = document.getElementById('achievementNotif');
                document.getElementById('achievementText').textContent = achievement.icon + ' ' + achievement.name + ': ' + achievement.desc;
                notif.classList.add('show');
                
                setTimeout(() => {
                    notif.classList.remove('show');
                }, 4000);
            }
            
            updateStatsUI();
        }

        function initializeInventory() {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 8; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                slot.id = `inv-slot-${i}`;
                grid.appendChild(slot);
            }
        }

        function addToInventory(itemId) {
            if (rpgStats.inventory.includes(itemId)) return;
            
            rpgStats.inventory.push(itemId);
            const slotIndex = rpgStats.inventory.length - 1;
            const slot = document.getElementById(`inv-slot-${slotIndex}`);
            
            if (slot) {
                slot.textContent = itemIcons[itemId];
                slot.classList.add('filled');
                slot.title = itemId.charAt(0).toUpperCase() + itemId.slice(1);
                slot.dataset.itemId = itemId;
                
                // Add click handler to show item info
                slot.addEventListener('click', () => {
                    showItemInfo(itemId);
                });
            }
        }

        function showItemInfo(itemId) {
            const info = itemInfo[itemId];
            if (!info) return;
            
            playSound('click');
            document.getElementById('itemInfoTitle').textContent = info.name;
            document.getElementById('itemInfoIcon').textContent = itemIcons[itemId];
            document.getElementById('itemInfoText').textContent = info.description;
            document.getElementById('itemInfoGiver').textContent = info.giver;
            document.getElementById('itemInfoPanel').classList.add('show');
        }

        document.getElementById('closeItemInfo').addEventListener('click', () => {
            playSound('click');
            document.getElementById('itemInfoPanel').classList.remove('show');
        });

        function updatePlayerNames() {
            const herName = document.getElementById('herName');
            const himName = document.getElementById('himName');
            
            herName.style.left = '50%';
            herName.style.transform = 'translateX(-50%)';
            herName.style.top = '-25px';
            
            himName.style.left = '50%';
            himName.style.transform = 'translateX(-50%)';
            himName.style.top = '-25px';
        }

        function createRomanticParticles() {
            const room = document.getElementById('room');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 10 + 's';
                particle.style.animationDuration = (8 + Math.random() * 6) + 's';
                room.appendChild(particle);
            }
        }

        let himIdleInterval;
        function startHimIdleAnimation() {
            let frame = 1;
            himIdleInterval = setInterval(() => {
                if (!gameState.kissAnimating && !gameState.isSleeping) {
                    frame = frame === 1 ? 2 : 1;
                    document.getElementById('himSprite').src = 
                        `https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/him/idle${frame}.png`;
                }
            }, 550);
        }

        // Enhanced showDialog with talking animation and optional continue button
        function showDialog(message, avatar = 'him', showContinue = false) {
            const textbox = document.getElementById('textboxContainer');
            const dialogText = document.getElementById('dialogText');
            const avatarImg = document.getElementById('avatarImg');
            const continueBtn = document.getElementById('continueBtn');
            
            avatarImg.src = `https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/talk_popup/${avatar}.png`;
            dialogText.textContent = message;
            
            // Add talking animation
            avatarImg.classList.add('talking');
            
            textbox.classList.add('show');
            playSound('dialogue');
            
            // Show continue button only if requested (for item collection)
            if (showContinue) {
                continueBtn.classList.add('show');
            } else {
                continueBtn.classList.remove('show');
            }
            
            gameState.canMove = false;
            gameState.dialogueActive = true;
        }

        function hideDialog() {
            const textbox = document.getElementById('textboxContainer');
            const avatarImg = document.getElementById('avatarImg');
            const continueBtn = document.getElementById('continueBtn');
            
            textbox.classList.remove('show');
            avatarImg.classList.remove('talking');
            continueBtn.classList.remove('show');
            gameState.canMove = true;
            gameState.dialogueActive = false;
        }

        document.getElementById('continueBtn').addEventListener('click', () => {
            hideDialog();
            document.getElementById('dialogueChoices').classList.remove('show');
        });

        function getCharacterHitbox(x, y, type = 'her') {
            const hitbox = CHARACTER_HITBOX[type];
            return {
                x: x + hitbox.offsetX,
                y: 618 - y - hitbox.height - hitbox.offsetY,
                width: hitbox.width,
                height: hitbox.height
            };
        }

        function checkCollision(newX, newY) {
            const charBox = getCharacterHitbox(newX, newY, 'her');

            for (let box of collisionBoxes) {
                if (charBox.x < box.x + box.width &&
                    charBox.x + charBox.width > box.x &&
                    charBox.y < box.y + box.height &&
                    charBox.y + charBox.height > box.y) {
                    return true;
                }
            }
            return false;
        }

        function checkProximityToHim() {
            const herBox = getCharacterHitbox(gameState.herPosition.x, gameState.herPosition.y, 'her');
            const himBox = getCharacterHitbox(gameState.himPosition.x, gameState.himPosition.y, 'him');
            
            const herCenterX = herBox.x + herBox.width / 2;
            const herCenterY = herBox.y + herBox.height / 2;
            const himCenterX = himBox.x + himBox.width / 2;
            const himCenterY = himBox.y + himBox.height / 2;
            
            const distance = Math.sqrt(
                Math.pow(herCenterX - himCenterX, 2) + 
                Math.pow(herCenterY - himCenterY, 2)
            );
            
            const isNear = distance < 120;
            
            if (isNear !== gameState.isNearHim) {
                gameState.isNearHim = isNear;
                const hint = document.getElementById('proximityHint');
                if (isNear && gameState.allItemsCollected && gameState.itemsCollected.includes('letter') && !quests.find(q => q.id === 'kiss').completed) {
                    hint.classList.add('show');
                } else {
                    hint.classList.remove('show');
                }
            }
        }

        function checkProximityToBed() {
            if (!gameState.allQuestsComplete) return;

            const herBox = getCharacterHitbox(gameState.herPosition.x, gameState.herPosition.y, 'her');
            const bedBox = { x: 90, y: 156, width: 156, height: 280 };
            
            const herCenterX = herBox.x + herBox.width / 2;
            const herCenterY = herBox.y + herBox.height / 2;
            const bedCenterX = bedBox.x + bedBox.width / 2;
            const bedCenterY = bedBox.y + bedBox.height / 2;
            
            const distance = Math.sqrt(
                Math.pow(herCenterX - bedCenterX, 2) + 
                Math.pow(herCenterY - bedCenterY, 2)
            );
            
            const isNear = distance < 150;
            
            if (isNear !== gameState.isNearBed) {
                gameState.isNearBed = isNear;
                const bedHint = document.getElementById('bedHint');
                const bed = document.getElementById('bed');
                
                if (isNear && !gameState.isSleeping) {
                    bedHint.classList.add('show');
                    bed.classList.add('interactive');
                } else {
                    bedHint.classList.remove('show');
                    if (!gameState.isSleeping) {
                        bed.classList.remove('interactive');
                    }
                }
            }
        }

        function updateZIndex() {
            const her = document.getElementById('her');
            const him = document.getElementById('him');
            const himY = gameState.himPosition.y;
            const herY = gameState.herPosition.y;
            
            if (herY < himY) {
                her.style.zIndex = '40';
            } else {
                her.style.zIndex = '50';
            }
        }

        const keys = {};
        let stepCount = 0;

        window.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            if (['w', 'a', 's', 'd', 'arrowup', 'arrowdown', 'arrowleft', 'arrowright'].includes(e.key.toLowerCase())) {
                e.preventDefault();
            }
        });
        window.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        function updateMovement() {
            if (!gameState.canMove || gameState.kissAnimating || gameState.isSleeping) {
                requestAnimationFrame(updateMovement);
                return;
            }

            const speed = 1.5;
            let moved = false;
            let newX = gameState.herPosition.x;
            let newY = gameState.herPosition.y;
            let newDirection = gameState.herDirection;

            if (keys['w'] || keys['arrowup']) {
                const testY = newY + speed;
                if (!checkCollision(newX, testY)) {
                    newY = testY;
                    newDirection = 'back';
                    moved = true;
                }
            }
            if (keys['s'] || keys['arrowdown']) {
                const testY = newY - speed;
                if (!checkCollision(newX, testY)) {
                    newY = testY;
                    newDirection = 'front';
                    moved = true;
                }
            }
            if (keys['a'] || keys['arrowleft']) {
                const testX = newX - speed;
                if (!checkCollision(testX, newY)) {
                    newX = testX;
                    newDirection = 'left';
                    moved = true;
                }
            }
            if (keys['d'] || keys['arrowright']) {
                const testX = newX + speed;
                if (!checkCollision(testX, newY)) {
                    newX = testX;
                    newDirection = 'right';
                    moved = true;
                }
            }

            if (moved) {
                stepCount++;
                if (stepCount >= 1000) {
                    unlockAchievement('explorer');
                }
            }

            newX = Math.max(20, Math.min(720, newX));
            newY = Math.max(80, Math.min(500, newY));

            gameState.herPosition.x = newX;
            gameState.herPosition.y = newY;
            document.getElementById('her').style.left = newX + 'px';
            document.getElementById('her').style.bottom = newY + 'px';

            const herSprite = document.getElementById('herSprite');
            
            if (moved) {
                gameState.herDirection = newDirection;
                gameState.frameCounter++;
                
                // Cycle between 1 and 2 for walk frames (walk1.png and walk2.png)
                if (gameState.frameCounter % 10 === 0) {
                    gameState.walkFrame = gameState.walkFrame === 1 ? 2 : 1;
                }
                
                // Always use walk frames when moving
                herSprite.src = `https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/her/${newDirection}_walk${gameState.walkFrame}.png`;
            } else {
                gameState.walkFrame = 1;
                gameState.frameCounter = 0;
                herSprite.src = `https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/her/${gameState.herDirection}_stand.png`;
            }

            checkProximityToHim();
            checkProximityToBed();
            updateZIndex();
            requestAnimationFrame(updateMovement);
        }
        updateMovement();

        // ===== NEW RPG SYSTEM FUNCTIONS =====
        
        // Save/Load System
        function saveGame(slot = 'quick') {
            const saveData = {
                rpgStats: rpgStats,
                gameState: gameState,
                quests: quests,
                timestamp: Date.now(),
                playTime: Math.floor((Date.now() - gameStartTime) / 1000)
            };
            
            localStorage.setItem(`cozyGame_save_${slot}`, JSON.stringify(saveData));
            const saveInfo = document.getElementById(`save${slot}Info`);
            if (saveInfo) {
                saveInfo.textContent = `Level ${rpgStats.level} - ${new Date().toLocaleString()}`;
            }
            showNotification('Game Saved!', 'üíæ');
            gameState.lastSaveTime = Date.now();
        }

        function loadGame(slot = 'quick') {
            const saveData = localStorage.getItem(`cozyGame_save_${slot}`);
            if (!saveData) {
                showNotification('No save data found', '‚ùå');
                return;
            }
            
            const data = JSON.parse(saveData);
            Object.assign(rpgStats, data.rpgStats);
            Object.assign(gameState, data.gameState);
            Object.assign(quests, data.quests);
            
            updateStatsUI();
            updateQuestUI();
            showNotification('Game Loaded!', 'üìÇ');
        }

        function autoSave() {
            if (gameState.autoSaveEnabled) {
                saveGame('auto');
            }
        }

        // Run autosave every 2 minutes
        setInterval(autoSave, 120000);

        // Time/Weather System
        function updateTimeDisplay() {
            const timeEmojis = { morning: 'üåÖ', afternoon: '‚òÄÔ∏è', evening: 'üåÜ', night: 'üåô' };
            const weatherEmojis = { clear: '‚òÄÔ∏è', rain: 'üåßÔ∏è', snow: '‚ùÑÔ∏è', sunny: '‚òÄÔ∏è', cherry: 'üå∏' };
            
            document.getElementById('timeDisplay').textContent = `${timeEmojis[gameState.timeOfDay]} ${gameState.timeOfDay.charAt(0).toUpperCase() + gameState.timeOfDay.slice(1)} - Day ${gameState.currentDay}`;
            document.getElementById('weatherDisplay').textContent = `${weatherEmojis[gameState.weather]} ${gameState.weather.charAt(0).toUpperCase() + gameState.weather.slice(1)}`;
            document.getElementById('energyDisplay').textContent = `‚ö° Energy: ${Math.floor(rpgStats.energy)}/${rpgStats.maxEnergy}`;
            document.getElementById('healthDisplay').textContent = `‚ù§Ô∏è Health: ${Math.floor(rpgStats.health)}/${rpgStats.maxHealth}`;
        }

        function advanceTime() {
            const times = ['morning', 'afternoon', 'evening', 'night'];
            const currentIndex = times.indexOf(gameState.timeOfDay);
            
            if (currentIndex === 3) {
                gameState.timeOfDay = 'morning';
                gameState.currentDay++;
                rpgStats.energy = Math.min(rpgStats.maxEnergy, rpgStats.energy + 50); // Rest bonus
            } else {
                gameState.timeOfDay = times[currentIndex + 1];
            }
            
            updateTimeDisplay();
            triggerRandomEvent();
        }

        // Energy regeneration over time
        setInterval(() => {
            if (rpgStats.energy < rpgStats.maxEnergy) {
                rpgStats.energy = Math.min(rpgStats.maxEnergy, rpgStats.energy + 0.5);
                updateStatsUI();
            }
        }, 5000);

        // Random Events System
        function triggerRandomEvent() {
            if (gameState.randomEventCooldown > 0) {
                gameState.randomEventCooldown--;
                return;
            }
            
            const roll = Math.random();
            for (const event of randomEvents) {
                if (roll < event.chance) {
                    showRandomEvent(event);
                    gameState.randomEventCooldown = 5;
                    break;
                }
            }
        }

        function showRandomEvent(event) {
            const notif = document.getElementById('randomEventNotif');
            document.getElementById('eventIcon').textContent = 'üé≤';
            document.getElementById('eventText').textContent = event.desc;
            
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 3000);
            
            // Apply rewards
            if (event.reward.currency) rpgStats.currency += event.reward.currency;
            if (event.reward.energy) rpgStats.energy = Math.min(rpgStats.maxEnergy, rpgStats.energy + event.reward.energy);
            if (event.reward.romance) rpgStats.relationship.romance += event.reward.romance;
            
            updateStatsUI();
        }

        function showNotification(message, icon = 'üí¨') {
            const notif = document.getElementById('randomEventNotif');
            document.getElementById('eventIcon').textContent = icon;
            document.getElementById('eventText').textContent = message;
            
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 2500);
        }

        // Equipment System
        function openEquipmentMenu() {
            document.getElementById('equipmentMenu').style.display = 'block';
            renderEquipment('outfits');
        }

        function renderEquipment(category) {
            const list = document.getElementById('equipmentList');
            list.innerHTML = '';
            
            const items = equipment[category];
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'equipment-item';
                if (item.owned) div.classList.add('owned');
                if (rpgStats.equipment[category.slice(0, -1)] === item.id) div.classList.add('equipped');
                
                div.innerHTML = `
                    <div><strong>${item.name}</strong></div>
                    <div style="font-size: 12px; opacity: 0.8;">
                        ${Object.entries(item.bonus).map(([k, v]) => `+${v} ${k}`).join(', ')}
                    </div>
                    <div style="font-size: 14px; margin-top: 5px;">
                        ${item.owned ? (rpgStats.equipment[category.slice(0, -1)] === item.id ? 'Equipped' : 'Equip') : `Buy: ${item.cost} üí∞`}
                    </div>
                `;
                
                div.onclick = () => {
                    if (!item.owned) {
                        if (rpgStats.currency >= item.cost) {
                            rpgStats.currency -= item.cost;
                            item.owned = true;
                            showNotification(`Purchased ${item.name}!`, 'üõçÔ∏è');
                            renderEquipment(category);
                            updateStatsUI();
                        } else {
                            showNotification('Not enough coins!', '‚ùå');
                        }
                    } else {
                        rpgStats.equipment[category.slice(0, -1)] = item.id;
                        applyEquipmentBonus(item);
                        showNotification(`Equipped ${item.name}!`, '‚ú®');
                        renderEquipment(category);
                    }
                };
                
                list.appendChild(div);
            });
        }

        function applyEquipmentBonus(item) {
            // Apply bonuses from equipment
            Object.entries(item.bonus).forEach(([stat, value]) => {
                if (rpgStats[stat] !== undefined) {
                    rpgStats[stat] = Math.min(rpgStats[`max${stat.charAt(0).toUpperCase() + stat.slice(1)}`] || 999, rpgStats[stat] + value);
                }
            });
            updateStatsUI();
        }

        // Skill Tree System
        function openSkillsMenu() {
            document.getElementById('skillsMenu').style.display = 'block';
            renderSkills();
        }

        function renderSkills() {
            Object.entries(skillTree).forEach(([category, skills]) => {
                const container = document.getElementById(`${category}Skills`);
                container.innerHTML = '';
                
                skills.forEach(skill => {
                    const div = document.createElement('div');
                    div.className = 'skill-item';
                    if (skill.unlocked) div.classList.add('unlocked');
                    if (skill.requires && !skillTree[category].find(s => s.id === skill.requires)?.unlocked) div.classList.add('locked');
                    
                    div.innerHTML = `
                        <div><strong>${skill.name}</strong></div>
                        <div style="font-size: 11px; opacity: 0.8;">${skill.desc}</div>
                        <div style="font-size: 12px; margin-top: 3px;">Cost: ${skill.cost} SP</div>
                    `;
                    
                    div.onclick = () => {
                        if (!skill.unlocked && rpgStats.skillPoints >= skill.cost) {
                            if (!skill.requires || skillTree[category].find(s => s.id === skill.requires)?.unlocked) {
                                rpgStats.skillPoints -= skill.cost;
                                skill.unlocked = true;
                                rpgStats.unlockedSkills.push(skill.id);
                                showNotification(`Unlocked ${skill.name}!`, 'üéØ');
                                renderSkills();
                                updateStatsUI();
                                
                                // Check for achievements
                                if (rpgStats.unlockedSkills.length === Object.values(skillTree).flat().length) {
                                    unlockAchievement('skill_master');
                                }
                            } else {
                                showNotification('Required skill not unlocked!', '‚ùå');
                            }
                        } else if (skill.unlocked) {
                            showNotification('Already unlocked!', '‚ÑπÔ∏è');
                        } else {
                            showNotification('Not enough skill points!', '‚ùå');
                        }
                    };
                    
                    container.appendChild(div);
                });
            });
        }

        // Crafting System
        function openCraftingMenu() {
            if (!rpgStats.unlockedSkills.includes('basic_crafting')) {
                showNotification('Unlock Basic Crafting skill first!', 'üîí');
                return;
            }
            document.getElementById('craftingMenu').style.display = 'block';
            renderCrafting();
        }

        function renderCrafting() {
            const container = document.getElementById('craftingRecipes');
            container.innerHTML = '';
            
            craftingRecipes.forEach(recipe => {
                const div = document.createElement('div');
                div.className = 'craft-item';
                
                const canCraft = Object.entries(recipe.materials).every(([mat, count]) => 
                    (rpgStats.craftingMaterials[mat] || 0) >= count
                );
                
                div.innerHTML = `
                    <div><strong>${recipe.name}</strong></div>
                    <div style="font-size: 12px; opacity: 0.8;">
                        ${Object.entries(recipe.materials).map(([m, c]) => `${m}: ${c}`).join(', ')}
                    </div>
                    <div style="font-size: 12px; margin-top: 5px;">+${recipe.affection} Affection</div>
                `;
                
                div.onclick = () => {
                    if (canCraft) {
                        Object.entries(recipe.materials).forEach(([mat, count]) => {
                            rpgStats.craftingMaterials[mat] -= count;
                        });
                        rpgStats.relationship.affection += recipe.affection;
                        showNotification(`Crafted ${recipe.name}!`, 'üî®');
                        renderCrafting();
                        
                        // Track crafting achievement
                        if (!rpgStats.completedEvents.includes(`craft_${recipe.id}`)) {
                            rpgStats.completedEvents.push(`craft_${recipe.id}`);
                            if (rpgStats.completedEvents.filter(e => e.startsWith('craft_')).length >= 5) {
                                unlockAchievement('crafter');
                            }
                        }
                    } else {
                        showNotification('Missing materials!', '‚ùå');
                    }
                };
                
                container.appendChild(div);
            });
        }

        // Cooking System
        function openCookingMenu() {
            if (!rpgStats.unlockedSkills.includes('basic_cooking')) {
                showNotification('Unlock Basic Cooking skill first!', 'üîí');
                return;
            }
            document.getElementById('cookingMenu').style.display = 'block';
            renderCooking();
        }

        function renderCooking() {
            const container = document.getElementById('cookingRecipes');
            container.innerHTML = '';
            
            cookingRecipes.forEach(recipe => {
                const div = document.createElement('div');
                div.className = 'cook-item';
                
                div.innerHTML = `
                    <div><strong>${recipe.name}</strong></div>
                    <div style="font-size: 12px; opacity: 0.8;">
                        ${Object.entries(recipe.ingredients).map(([i, c]) => `${i}: ${c}`).join(', ')}
                    </div>
                    <div style="font-size: 12px; margin-top: 5px;">+${recipe.energy} Energy, +${recipe.love} Love</div>
                `;
                
                div.onclick = () => {
                    rpgStats.energy = Math.min(rpgStats.maxEnergy, rpgStats.energy + recipe.energy);
                    rpgStats.love = Math.min(rpgStats.maxLove, rpgStats.love + recipe.love);
                    showNotification(`Cooked ${recipe.name}!`, 'üç≥');
                    updateStatsUI();
                    
                    // Track cooking achievement
                    if (!rpgStats.completedEvents.includes(`cook_${recipe.id}`)) {
                        rpgStats.completedEvents.push(`cook_${recipe.id}`);
                        if (rpgStats.completedEvents.filter(e => e.startsWith('cook_')).length >= 10) {
                            unlockAchievement('master_chef');
                        }
                    }
                };
                
                container.appendChild(div);
            });
        }

        // Gift Shop System
        function openGiftShop() {
            document.getElementById('giftShop').style.display = 'block';
            renderGiftShop();
        }

        function renderGiftShop() {
            const container = document.getElementById('giftItems');
            container.innerHTML = '';
            
            giftItems.forEach(gift => {
                const div = document.createElement('div');
                div.className = 'gift-item';
                
                div.innerHTML = `
                    <div><strong>${gift.name}</strong></div>
                    <div style="font-size: 12px; opacity: 0.8;">
                        +${gift.affection} Affection
                        ${gift.romance ? `, +${gift.romance} Romance` : ''}
                    </div>
                    <div style="font-size: 14px; margin-top: 5px;">Buy: ${gift.cost} üí∞</div>
                `;
                
                div.onclick = () => {
                    if (rpgStats.currency >= gift.cost) {
                        rpgStats.currency -= gift.cost;
                        rpgStats.relationship.affection += gift.affection;
                        if (gift.romance) rpgStats.relationship.romance += gift.romance;
                        showNotification(`Gave ${gift.name} to Amon!`, 'üéÅ');
                        updateStatsUI();
                        
                        // Track gift giving achievement
                        if (!rpgStats.completedEvents.includes(`gift_${gift.id}`)) {
                            rpgStats.completedEvents.push(`gift_${gift.id}`);
                            if (rpgStats.completedEvents.filter(e => e.startsWith('gift_')).length >= 5) {
                                unlockAchievement('gift_giver');
                            }
                        }
                    } else {
                        showNotification('Not enough coins!', '‚ùå');
                    }
                };
                
                container.appendChild(div);
            });
        }

        // Tutorial System
        let tutorialStep = 0;
        const tutorialSteps = [
            { text: 'Welcome to CozyBeds! Use WASD or Arrow Keys to move Diana around.', icon: 'üéÆ' },
            { text: 'Collect items around the room by clicking on them. Each item comes with a special message!', icon: 'üéÅ' },
            { text: 'Click the PC to do activities together. Different activities boost different stats!', icon: 'üíª' },
            { text: 'Open the Quick Menu on the right to access new features like Equipment, Skills, and more!', icon: 'üìã' },
            { text: 'Complete quests to gain XP and level up. Level ups give you skill points!', icon: '‚≠ê' },
            { text: 'Save your game regularly using the Save/Load menu. Auto-save is enabled by default.', icon: 'üíæ' },
            { text: 'Have fun exploring and building your relationship! üíï', icon: 'üòä' }
        ];

        function startTutorial() {
            if (!gameState.tutorialComplete) {
                showTutorialStep();
            }
        }

        function showTutorialStep() {
            if (tutorialStep >= tutorialSteps.length) {
                gameState.tutorialComplete = true;
                document.getElementById('tutorialOverlay').style.display = 'none';
                return;
            }
            
            const step = tutorialSteps[tutorialStep];
            document.getElementById('tutorialText').textContent = step.text;
            document.getElementById('tutorialOverlay').style.display = 'flex';
        }

        // UI Event Listeners for new systems
        document.getElementById('openSave').addEventListener('click', () => {
            document.getElementById('saveMenu').style.display = 'block';
            // Update save slot info
            [1, 2, 3].forEach(slot => {
                const saveData = localStorage.getItem(`cozyGame_save_${slot}`);
                const infoEl = document.getElementById(`save${slot}Info`);
                if (saveData) {
                    const data = JSON.parse(saveData);
                    infoEl.textContent = `Level ${data.rpgStats.level} - ${new Date(data.timestamp).toLocaleString()}`;
                } else {
                    infoEl.textContent = 'Empty';
                }
            });
        });

        document.getElementById('closeSaveMenu').addEventListener('click', () => {
            document.getElementById('saveMenu').style.display = 'none';
        });

        document.querySelectorAll('.save-slot-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const slot = btn.dataset.slot;
                if (confirm('Save or Load? (OK = Save, Cancel = Load)')) {
                    saveGame(slot);
                } else {
                    loadGame(slot);
                }
            });
        });

        document.getElementById('quickSave').addEventListener('click', () => saveGame('quick'));
        document.getElementById('quickLoad').addEventListener('click', () => loadGame('quick'));

        document.getElementById('openEquipment').addEventListener('click', openEquipmentMenu);
        document.getElementById('closeEquipment').addEventListener('click', () => {
            document.getElementById('equipmentMenu').style.display = 'none';
        });

        document.querySelectorAll('.eq-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.eq-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                renderEquipment(tab.dataset.tab);
            });
        });

        document.getElementById('openSkills').addEventListener('click', openSkillsMenu);
        document.getElementById('closeSkills').addEventListener('click', () => {
            document.getElementById('skillsMenu').style.display = 'none';
        });

        document.getElementById('openCrafting').addEventListener('click', openCraftingMenu);
        document.getElementById('closeCrafting').addEventListener('click', () => {
            document.getElementById('craftingMenu').style.display = 'none';
        });

        document.getElementById('openCooking').addEventListener('click', openCookingMenu);
        document.getElementById('closeCooking').addEventListener('click', () => {
            document.getElementById('cookingMenu').style.display = 'none';
        });

        document.getElementById('openGiftShop').addEventListener('click', openGiftShop);
        document.getElementById('closeGiftShop').addEventListener('click', () => {
            document.getElementById('giftShop').style.display = 'none';
        });

        document.getElementById('nextTutorial').addEventListener('click', () => {
            tutorialStep++;
            showTutorialStep();
        });

        document.getElementById('skipTutorial').addEventListener('click', () => {
            gameState.tutorialComplete = true;
            document.getElementById('tutorialOverlay').style.display = 'none';
        });

        // Add some starting crafting materials
        rpgStats.craftingMaterials = {
            paper: 3,
            ink: 2,
            wood: 2,
            glass: 1,
            thread: 3,
            beads: 5
        };

        // Initialize game start time for play time tracking
        const gameStartTime = Date.now();

        // Start tutorial on first play
        setTimeout(() => {
            if (!gameState.tutorialComplete && !localStorage.getItem('cozyGame_save_quick')) {
                startTutorial();
            }
        }, 2000);

        // ===== END OF NEW RPG SYSTEMS =====

        ['teddybear', 'flower', 'giftbox', 'steak', 'cake', 'wine', 'letter'].forEach(itemId => {
            document.getElementById(itemId).addEventListener('click', () => {
                // Prevent clicking items during dialogue
                if (gameState.dialogueActive) return;
                
                playSound('collect');
                collectItem(itemId);
            });
        });

        function collectItem(itemId) {
            if (gameState.itemsCollected.includes(itemId)) return;
            
            // Stop idle timer since player is actively playing
            clearTimeout(idleTimer);
            idleWarningShown = false;
            
            const item = document.getElementById(itemId);
            item.classList.add('collected');
            gameState.itemsCollected.push(itemId);
            completeQuest(itemId);
            
            addToInventory(itemId);
            const quest = quests.find(q => q.id === itemId);
            if (quest) {
                addXP(quest.xp);
                addLove(10);
            }
            
            if (gameState.itemsCollected.length === 1) {
                unlockAchievement('first_item');
            }
            if (gameState.itemsCollected.length === 3) {
                unlockAchievement('half_items');
            }
            
            for (let i = 0; i < 4; i++) {
                setTimeout(() => {
                    const randomX = item.offsetLeft + 24 + (Math.random() * 20 - 10);
                    const randomY = item.offsetTop + 24 + (Math.random() * 20 - 10);
                    createEffect('sparkle', randomX, randomY);
                }, i * 120);
            }
            
            // Show item message with continue button
            showDialog(itemMessages[itemId], 'him', true);
            
            const requiredItems = ['teddybear', 'flower', 'giftbox', 'steak', 'cake', 'wine'];
            const allCollected = requiredItems.every(id => gameState.itemsCollected.includes(id));
            
            if (allCollected && !gameState.allItemsCollected) {
                gameState.allItemsCollected = true;
                unlockAchievement('all_items');
                addLove(25);
                
                setTimeout(() => {
                    // Add a special dialogue when all items are collected
                    hideDialog();
                    setTimeout(() => {
                        showDialog("You found everything! Now check the center of the room for one last thing... üíå", 'him', false);
                        setTimeout(() => {
                            hideDialog();
                            const letter = document.getElementById('letter');
                            letter.style.display = 'block';
                            for (let i = 0; i < 6; i++) {
                                setTimeout(() => {
                                    createEffect('sparkle', letter.offsetLeft + 24, letter.offsetTop + 24);
                                }, i * 180);
                            }
                        }, 2500);
                    }, 1000);
                }, 1200);
            }
        }

        // Kiss interaction with specific sequential dialogue
        document.getElementById('him').addEventListener('click', () => {
            playSound('click');
            
            if (!gameState.isNearHim) {
                const randomMessages = [
                    "Come here princess :)",
                    "YOU ARE TOO FAR!",
                    "I'm waiting for you to come to me :)"
                ];
                const randomMsg = randomMessages[Math.floor(Math.random() * randomMessages.length)];
                showDialog(randomMsg, 'him', false);
                setTimeout(hideDialog, 2500);
                return;
            }
            
            if (!gameState.allItemsCollected || !gameState.itemsCollected.includes('letter')) {
                const encouragementMessages = [
                    "Find all the items dumdum",
                    "Did you find the items blind bat?",
                    "There's still more to discover in our room I promise",
                    "Find all my gifts first, then we can smooch"
                ];
                const randomMsg = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
                showDialog(randomMsg, 'him', false);
                setTimeout(hideDialog, 2500);
                return;
            }
            
            // Allow kissing multiple times, but only animate if not currently animating
            if (gameState.kissAnimating) return;
            
            // If already kissed before, show different dialogues
            if (quests.find(q => q.id === 'kiss').completed) {
                const repeatKissDialogues = [
                    "Again? Cute",
                    "Can't get enough of me, hehe?",
                    "MORE!",
                    "All yours princess"
                ];
                const randomMsg = repeatKissDialogues[Math.floor(Math.random() * repeatKissDialogues.length)];
                showDialog(randomMsg, 'him', false);
                setTimeout(() => {
                    hideDialog();
                    playKissAnimation(true); // Pass true to skip quest completion
                }, 2500);
                return;
            }
            
            // Start kiss dialogue sequence
            showDialog("Touch me", 'him', false);
            setTimeout(() => {
                hideDialog();
                setTimeout(() => {
                    showDialogueChoices('kiss', [
                        { 
                            text: 'Yes üíï', 
                            class: 'flirty',
                            response: "Freaky bastard",
                            callback: () => {
                                showDialog("Touch me HARDER!!!!", 'him', false);
                                setTimeout(() => {
                                    hideDialog();
                                    playKissAnimation();
                                }, 2500);
                            }
                        },
                        { 
                            text: 'No üò§', 
                            class: 'mean',
                            response: "NUHUH BITCH",
                            callback: () => {
                                handleKissRefusal();
                            }
                        }
                    ]);
                }, 500);
            }, 2500);
        });

        function handleKissRefusal() {
            kissRefusalCount++;
            
            const refusalDialogues = [
                { him: "baby pls :( im gonna get erased if you don't :(", her1: "Okay fine", her2: "Still no" },
                { him: "pls", her1: "Ugh okay", her2: "Nope" },
                { him: "ok so you hate me?", her1: "No I don't, come here", her2: "Maybe" }
            ];
            
            const idx = Math.min(kissRefusalCount - 1, refusalDialogues.length - 1);
            const dialogue = refusalDialogues[idx];
            
            showDialog(dialogue.him, 'him', false);
            
            setTimeout(() => {
                hideDialog();
                setTimeout(() => {
                    if (kissRefusalCount >= 3) {
                        // After 3rd refusal, force it
                        showDialog("I'll just sudoop you to kiss me bitchass üò§", 'him', false);
                        setTimeout(() => {
                            hideDialog();
                            playKissAnimation();
                        }, 2500);
                    } else {
                        // Ask again
                        showDialogueChoices('kiss_retry', [
                            { 
                                text: dialogue.her1 + ' üíï', 
                                class: 'flirty',
                                response: "I'm considering it",
                                callback: () => {
                                    showDialog("YESSSS!", 'him', false);
                                    setTimeout(() => {
                                        hideDialog();
                                        playKissAnimation();
                                    }, 2500);
                                }
                            },
                            { 
                                text: dialogue.her2 + ' üò§', 
                                class: 'mean',
                                response: "Nuh-uh",
                                callback: () => {
                                    handleKissRefusal();
                                }
                            }
                        ]);
                    }
                }, 500);
            }, 2500);
        }

        function playKissAnimation(skipQuestCompletion = false) {
            gameState.kissAnimating = true;
            gameState.canMove = false;
            kissRefusalCount = 0;
            
            playSound('success');
            const himSprite = document.getElementById('himSprite');
            const herSprite = document.getElementById('herSprite');
            const overlay = document.getElementById('kissOverlay');
            const hint = document.getElementById('proximityHint');
            
            hint.classList.remove('show');
            clearInterval(himIdleInterval);
            
            let kissFrame = 1;
            const kissInterval = setInterval(() => {
                himSprite.src = `https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/him/beingkissed${kissFrame}.png`;
                herSprite.src = `https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/her/kiss${kissFrame}_right.png`;
                
                if (kissFrame === 2) {
                    overlay.classList.add('active');
                    for (let i = 0; i < 10; i++) {
                        setTimeout(() => {
                            const him = document.getElementById('him');
                            const angle = (Math.PI * 2 * i) / 10;
                            const radius = 40 + Math.random() * 20;
                            const offsetX = Math.cos(angle) * radius;
                            const offsetY = Math.sin(angle) * radius;
                            createEffect('heart', 
                                him.offsetLeft + 42 + offsetX, 
                                him.offsetTop - 30 + offsetY);
                        }, i * 130);
                    }
                }
                
                kissFrame++;
                if (kissFrame > 3) {
                    clearInterval(kissInterval);
                    
                    setTimeout(() => {
                        overlay.classList.remove('active');
                        himSprite.src = 'https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/him/idle1.png';
                        herSprite.src = 'https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/her/smile_front.png';
                        
                        // Only complete quest and show full message on first kiss
                        if (!skipQuestCompletion) {
                            showDialog("Thank you for everything, my beautiful girl. I love you so much! Now we can rest together... üíïüíïüíï", 'him', false);
                            completeQuest('kiss');
                            
                            const quest = quests.find(q => q.id === 'kiss');
                            if (quest) {
                                addXP(quest.xp);
                                addLove(30);
                            }
                            unlockAchievement('first_kiss');
                            
                            checkAllQuestsComplete();
                        } else {
                            // For repeat kisses, just add some love
                            addLove(5);
                        }
                        
                        setTimeout(() => {
                            if (!skipQuestCompletion) {
                                hideDialog();
                            }
                            gameState.kissAnimating = false;
                            gameState.canMove = true;
                            startHimIdleAnimation();
                        }, skipQuestCompletion ? 500 : 3500);
                    }, 1200);
                }
            }, 750);
        }

        function checkAllQuestsComplete() {
            const allComplete = quests
                .filter(q => q.id !== 'sleep')
                .every(q => q.completed);
            
            if (allComplete) {
                gameState.allQuestsComplete = true;
            }
        }

        // Sleep interaction with Yes/No choice format (matching kiss format)
        document.getElementById('bed').addEventListener('click', () => {
            playSound('click');
            
            if (!gameState.allQuestsComplete) {
                showDialog("Complete all the quests first, my love! üíï", 'him', false);
                setTimeout(hideDialog, 2500);
                return;
            }

            if (!gameState.isNearBed) {
                showDialog("Come closer to the bed first, baby! üíï", 'him', false);
                setTimeout(hideDialog, 2500);
                return;
            }
            
            // Allow multiple sleep sessions
            if (gameState.isSleeping) {
                showDialog("Already cozy in bed... want to get up? üò¥", 'him', false);
                setTimeout(hideDialog, 2500);
                return;
            }
            
            // Start sleep dialogue sequence with choice
            showDialog("Les eep princess", 'him', false);
            setTimeout(() => {
                hideDialog();
                setTimeout(() => {
                    showDialogueChoices('sleep', [
                        { 
                            text: 'Yes üíï', 
                            class: 'flirty',
                            response: "Oki babyy, let me take off my contact lenses",
                            callback: () => {
                                showDialog("Ofcourse m'lady", 'him', false);
                                setTimeout(() => {
                                    hideDialog();
                                    playSleepAnimation();
                                }, 2500);
                            }
                        },
                        { 
                            text: 'No üò§', 
                            class: 'mean',
                            response: "Noooooooo I didn't put my podcast yetttt",
                            callback: () => {
                                handleSleepRefusal();
                            }
                        }
                    ]);
                }, 500);
            }, 2500);
        });

        function handleSleepRefusal() {
            sleepRefusalCount++;
            
            const refusalDialogues = [
                { him: "You and your fuckass podcast AAAAGHHHHH!", her1: "Okayy", her2: "No" },
                { him: "Come on baby", her1: "Okay okay fine", her2: "Nuhuh"},
                { him: "Please princess? you need resttt", her1: "Okay :(", her2: "5 more minutes" }
            ];
            
            const idx = Math.min(sleepRefusalCount - 1, refusalDialogues.length - 1);
            const dialogue = refusalDialogues[idx];
            
            showDialog(dialogue.him, 'him', false);
            
            setTimeout(() => {
                hideDialog();
                setTimeout(() => {
                    if (sleepRefusalCount >= 3) {
                        // After 3rd refusal, playful force
                        showDialog("I swear I will lick your braincells off in your sleep and shave your eyebrows if you don't", 'him', false);
                        setTimeout(() => {
                            hideDialog();
                            setTimeout(() => {
                                showDialog("OKAY OKAY I'M COMING", 'her', false);
                                setTimeout(() => {
                                    hideDialog();
                                    playSleepAnimation();
                                }, 2500);
                            }, 500);
                        }, 2500);
                    } else {
                        // Ask again with specific choices
                        showDialogueChoices('sleep_retry', [
                            { 
                                text: dialogue.her1, 
                                class: 'flirty',
                                response: "Okay okay you win, let's sleep",
                                callback: () => {
                                    showDialog("HEHEHEHEHEHEHEHEH!", 'him', false);
                                    setTimeout(() => {
                                        hideDialog();
                                        playSleepAnimation();
                                    }, 2500);
                                }
                            },
                            { 
                                text: dialogue.her2, 
                                class: 'mean',
                                response: "NUHUHHHH",
                                callback: () => {
                                    handleSleepRefusal();
                                }
                            }
                        ]);
                    }
                }, 500);
            }, 2500);
        }

        function playSleepAnimation() {
            gameState.isSleeping = true;
            gameState.canMove = false;
            sleepRefusalCount = 0;
            
            const himSprite = document.getElementById('himSprite');
            const herSprite = document.getElementById('herSprite');
            const her = document.getElementById('her');
            const him = document.getElementById('him');
            const bedHint = document.getElementById('bedHint');
            const sleepOverlay = document.getElementById('sleepOverlay');
            const sleepMessage = document.getElementById('sleepMessage');
            const gameBg = document.getElementById('gameBg');
            const herName = document.getElementById('herName');
            const himName = document.getElementById('himName');
            const cinematicFade = document.getElementById('cinematicFade');
            const endGameScreen = document.getElementById('endGameScreen');
            
            bedHint.classList.remove('show');
            clearInterval(himIdleInterval);
            
            herName.style.opacity = '0';
            himName.style.opacity = '0';
            
            // Fade to black before moving characters
            cinematicFade.classList.remove('fade-out');
            cinematicFade.classList.add('fade-in');
            
            setTimeout(() => {
                // Move characters while screen is black
                her.style.transition = 'all 1.5s ease';
                him.style.transition = 'all 1.5s ease';
                her.style.zIndex = '15';
                him.style.zIndex = '15';
                
                her.style.left = '95px';
                her.style.bottom = '130px';
                him.style.left = '50px';
                him.style.bottom = '130px';
                
                setTimeout(() => {
                    herSprite.src = 'https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/her/layonbed.png';
                    himSprite.src = 'https://raw.githubusercontent.com/Anonventions/cozygameplays/main/characters/him/laying.png';
                    
                    herSprite.style.width = '90px';
                    herSprite.style.height = '210px';
                    her.style.width = '90px';
                    her.style.height = '210px';
                    
                    himSprite.style.width = '90px';
                    himSprite.style.height = '210px';
                    him.style.width = '90px';
                    him.style.height = '210px';
                    
                    // Fade back in to show them in bed
                    cinematicFade.classList.remove('fade-in');
                    cinematicFade.classList.add('fade-out');
                }, 1500);
            }, 2000);
            
            setTimeout(() => {
                sleepOverlay.classList.add('active');
                gameBg.classList.add('sleeping');
                
                setTimeout(() => {
                    sleepMessage.classList.add('show');
                    
                    createSleepParticles();
                    
                    completeQuest('sleep');
                    
                    const quest = quests.find(q => q.id === 'sleep');
                    if (quest) {
                        addXP(quest.xp);
                        addLove(50);
                    }
                    unlockAchievement('sweet_dreams');
                    
                    if (rpgStats.achievements.length === achievements.length) {
                        setTimeout(() => unlockAchievement('perfect_love'), 2000);
                    }
                    
                    // Cinematic fade to black and end game screen
                    setTimeout(() => {
                        cinematicFade.classList.remove('fade-out');
                        cinematicFade.classList.add('fade-in');
                        
                        setTimeout(() => {
                            endGameScreen.classList.add('show');
                            cinematicFade.style.opacity = '0.8'; // Semi-transparent for visibility
                            cinematicFade.style.pointerEvents = 'none'; // Allow clicking buttons
                        }, 2000);
                    }, 5000);
                    
                }, 2000);
            }, 4000);
        }

        function createSleepParticles() {
            const room = document.getElementById('room');
            
            setInterval(() => {
                if (gameState.isSleeping) {
                    const zHer = document.createElement('div');
                    zHer.className = 'z-particle';
                    zHer.textContent = 'Z';
                    zHer.style.left = '85px';
                    zHer.style.bottom = '450px';
                    zHer.style.animationDelay = '0s';
                    room.appendChild(zHer);
                    setTimeout(() => zHer.remove(), 3000);
                    
                    setTimeout(() => {
                        const zHim = document.createElement('div');
                        zHim.className = 'z-particle';
                        zHim.textContent = 'Z';
                        zHim.style.left = '130px';
                        zHim.style.bottom = '450px';
                        zHim.style.animationDelay = '0s';
                        room.appendChild(zHim);
                        setTimeout(() => zHim.remove(), 3000);
                    }, 800);
                }
            }, 2500);
        }

        function createEffect(type, x, y) {
            const effect = document.createElement('img');
            effect.className = type === 'heart' ? 'effect heart-effect' : 'effect sparkle-effect';
            effect.src = `https://raw.githubusercontent.com/Anonventions/cozygameplays/main/effects/${type}.png`;
            effect.style.left = x + 'px';
            effect.style.top = y + 'px';
            document.getElementById('room').appendChild(effect);
            
            setTimeout(() => effect.remove(), 2500);
        }

        function completeQuest(questId) {
            const quest = quests.find(q => q.id === questId);
            if (quest && !quest.completed) {
                quest.completed = true;
                updateQuestUI();
            }
        }

        function updateQuestUI() {
            const questList = document.getElementById('questList');
            questList.innerHTML = quests.map(quest => 
                `<div class="quest-item ${quest.completed ? 'completed' : ''}">
                    <span class="quest-icon">${quest.completed ? '‚úì' : '‚óã'}</span>
                    ${quest.name}
                </div>`
            ).join('');
        }

        // End game button handlers
        document.getElementById('playAgainBtn').addEventListener('click', () => {
            playSound('click');
            location.reload();
        });

        document.getElementById('stayBtn').addEventListener('click', () => {
            playSound('click');
            // Just close the end game screen to let them stay in the scene
            document.getElementById('endGameScreen').classList.remove('show');
        });

        // PC Table click handler for activity panel
        document.getElementById('pcTable').addEventListener('click', () => {
            showActivityPanel();
        });

        // Add keyboard shortcut to open activity panel (press 'E' key)
        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'e' && !gameState.dialogueActive && !gameState.isSleeping) {
                showActivityPanel();
            }
        });
    </script>
</body>
</html>
